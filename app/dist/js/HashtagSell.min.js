/*! HashtagSell 06-05-2015 */
var htsApp=angular.module("htsApp",["globalVars","ui.router","ct.ui.router.extras.core","ct.ui.router.extras.dsr","ui.bootstrap","mentio","ui.bootstrap-slider","frapontillo.bootstrap-switch","ngTable","uiGmapgoogle-maps","ivh.treeview","vs-repeat","ui.bootstrap.datetimepicker","ngSanitize","ui-notification","ezfb","slick"]);htsApp.config(["$httpProvider","$stateProvider","$urlRouterProvider","$tooltipProvider","ivhTreeviewOptionsProvider","$locationProvider","ezfbProvider","ENV",function(a,b,c,d,e,f,g,h){a.defaults.headers.common["X-Requested-With"]="XMLHttpRequest",f.html5Mode({enabled:!0,requireBase:!1}),f.hashPrefix("!"),g.setLocale("en_US"),g.setInitParams({appId:h.fbAppId,version:"v2.1"}),d.setTriggers({show:"hide"});var i=["$q","Session","$state","$timeout","redirect",function(a,b,c,d,e){var f=a.defer();return console.log("checking login!",b.userObj),console.log("login Checker should redirect to",e),b.userObj.user_settings.loggedIn?f.resolve():(d(function(){c.go("signup",{redirect:e})}),f.reject()),f.promise}],j=["socketio","Session","$stateParams","splashFactory",function(a,b,c,d){if(b.userObj.user_settings.loggedIn&&(a.joinPostingRoom(c.id,"toggleSplash"),d.result&&"HSHTG"===d.result.external.source)){var e=d.result.username;a.joinUserRoom(e,b.userObj.user_settings.name)}}],k=["socketio","Session","$stateParams","splashFactory",function(a,b,c,d){if(b.userObj.user_settings.loggedIn&&(a.leavePostingRoom(c.id,"toggleSplash"),d.result&&"HSHTG"===d.result.external.source)){var e=d.result.username;a.leaveUserRoom(e)}}];c.otherwise(function(a,b){var c=a.get("$state");return c.go("404"),b.path()}),b.state("404",{views:{root:{templateUrl:"js/404/partials/404.html"}}}).state("profile",{url:"/profile",templateUrl:"js/profile/partials/profile.partial.html",controller:"profile.controller",resolve:{loginRequired:i,redirect:function(){return"profile"}}}).state("root",{url:"/",onEnter:function(a){a.go("feed")}}).state("feed",{url:"/feed",templateUrl:"js/feed/partials/feed.partial.html",controller:"feed.controller",resolve:{loginRequired:i,redirect:function(){return"feed"}}}).state("feed.splash",{url:"/:id",controller:"splashController",onEnter:j,onExit:k}).state("watchlist",{url:"/watchlist",templateUrl:"js/interested/partials/interested.html",controller:"myFavesController",resolve:{loginRequired:i,redirect:function(){return"watchlist"}}}).state("watchlist.questions",{url:"/questions/:postingId"}).state("watchlist.offers",{url:"/offers/:postingId"}).state("watchlist.splash",{url:"/:id",controller:"splashController",onEnter:j,onExit:k}).state("notifications",{url:"/notifications",templateUrl:"js/notifications/partials/notifications.html",controller:"notifications.controller",rresolve:{loginRequired:i,redirect:function(){return"notifications"}}}).state("myposts",{url:"/myposts",templateUrl:"js/myPosts/partials/myPosts.html",controller:"myPosts.controller",resolve:{loginRequired:i,redirect:function(){return"myposts"}}}).state("myposts.questions",{url:"/questions/:postingId"}).state("myposts.offers",{url:"/offers/:postingId"}).state("myposts.splash",{url:"/:id",controller:"splashController"}).state("settings",{url:"/settings",templateUrl:"js/settings/settings_partial.html",resolve:{loginRequired:i,redirect:function(){return"settings"}}}).state("settings.account",{url:"/account",templateUrl:"js/settings/account/partials/settings.account_partial.html",controller:"settings.account.controller"}).state("settings.password",{url:"/password",templateUrl:"js/settings/password/partials/settings.password_partial.html",controller:"settings.password.controller"}).state("settings.profile",{url:"/profile",templateUrl:"js/settings/profile/partials/settings.profile_partial.html",controller:"settings.profile.controller"}).state("settings.payment",{url:"/payment",templateUrl:"js/settings/payment/partials/settings.payment_partial.html",controller:"settings.payment.controller"}).state("results",{url:"/q/:q",params:{q:null,city:null,locationObj:null},controller:"results.controller",templateUrl:"js/results/partials/results_partial.html",resolve:{loginRequired:i,redirect:function(){return"results"}}}).state("results.splash",{url:"/:id",params:{q:null,city:null,locationObj:null,id:null},controller:"splashController",onEnter:j,onExit:k}).state("twitter",{url:"/tw/:id",controller:"splashController"}).state("facebook",{url:"/fb/:id",controller:"splashController"}).state("ebay",{url:"/eb/:id",controller:"splashController"}).state("amazon",{url:"/az/:id",controller:"splashController"}).state("signin",{url:"/signin?email&tour",params:{redirect:null,email:null,tour:null},controller:function(a,b){console.log(b.params),a.signInModal(b.params)}}).state("signup",{url:"/signup",params:{redirect:null},controller:function(a,b){a.signUpModal(b.params)}}).state("checkemail",{url:"/checkemail",params:{redirect:null},controller:function(a,b){a.checkEmailModal(b.params)}}).state("forgot",{url:"/forgot?msg",params:{redirect:null,msg:null},controller:function(a,b){a.forgotPasswordModal(b.params)}}).state("reset",{url:"/reset/:token/",controller:function(a,b){a.resetPasswordModal("signin",b.params.token)}}),e.set({twistieCollapsedTpl:'<span class="glyphicon glyphicon-chevron-right"></span>',twistieExpandedTpl:'<span class="glyphicon glyphicon-chevron-down"></span>',twistieLeafTpl:"",defaultSelectedState:!1})}]),htsApp.directive("matchinput",function(){return{require:"ngModel",restrict:"A",scope:{matchinput:"="},link:function(a,b,c,d){a.$watch(function(){return d.$pristine&&angular.isUndefined(d.$modelValue)||a.matchinput===d.$modelValue},function(a){d.$setValidity("match",a)})}}}),htsApp.filter("tel",function(){return function(a){if(!a)return"";var b=a.toString().trim().replace(/^\+/,"");if(b.match(/[^0-9]/))return a;var c,d,e;switch(b.length){case 10:c=1,d=b.slice(0,3),e=b.slice(3);break;case 11:c=b[0],d=b.slice(1,4),e=b.slice(4);break;case 12:c=b.slice(0,3),d=b.slice(3,5),e=b.slice(5);break;default:return a}return 1==c&&(c=""),e=e.slice(0,3)+"-"+e.slice(3),(c+" ("+d+") "+e).trim()}}),htsApp.filter("cleanHeading",["$sce",function(a){return function(b){return b.replace(/\w\S*/g,function(b){var c=new RegExp("\\S+([0-9];)");if(c.test(b))return"";var d=b.charAt(0).toUpperCase()+b.substr(1).toLowerCase();return a.trustAsHtml(d)})}}]),htsApp.filter("cleanBody",["$sce",function(a){return function(b){return b=b.replace(/[\r\n]/g,"<br />"),b.replace(/\b([A-Z]{2,})\b/g,function(b){var c=new RegExp("\\S+([0-9];)");if(c.test(b))return"";var d=b.charAt(0).toUpperCase()+b.substr(1).toLowerCase();return a.trustAsHtml(d)})}}]),htsApp.filter("cleanBodyExcerpt",["$sce",function(a){return function(b){return b.replace(/\b([A-Z]{2,})\b/g,function(b){var c=new RegExp("\\S+([0-9];)");if(c.test(b))return"";var d=b.charAt(0).toUpperCase()+b.substr(1).toLowerCase();return a.trustAsHtml(d)})}}]),htsApp.directive("awesomebar",["$sce",function(a){return{restrict:"A",require:"?ngModel",link:function(b,c,d,e){function f(){var a=c.html();d.stripBr&&"<br>"===a&&(a=""),e.$setViewValue(a)}e&&(e.$render=function(){console.log("doing this"),e.$viewValue!==c.html()&&c.html(a.getTrustedHtml(e.$viewValue||""))},c.on("keydown keyup",function(a){if(13===parseInt(a.which)&&"keydown"===a.type){var c=angular.element(document.querySelector("#mentioMenu"));"none"===c[0].style.display?(console.log("mentio list closed.. submitting query"),b.awesomeBarSubmit()):"block"===c[0].style.display&&console.log("mentio list open"),a.preventDefault()}else b.$apply(f)}),f())}}}]),htsApp.directive("sellbox",["$sce","$window",function(a,b){return{restrict:"A",require:"?ngModel",link:function(c,d,e,f){function g(){var a=d.html();e.stripBr&&"<br>"===a&&(a=""),f.$setViewValue(a)}function h(a){var b=document.createElement("DIV");return b.innerHTML=a,b.textContent||b.innerText||""}if(f){f.$render=function(){console.log("doing this"),f.$viewValue!==d.html()&&d.html(a.getTrustedHtml(f.$viewValue||""))};var i=b.JsDiff,j=!1;c.$watch("jsonObj.body",function(a,b){if(console.log(j),j){j=!1,console.log("==========Backspace Pressed==========");var d=h(b),e=h(a);console.log("Old Stripped",d),console.log("New Stripped",e);var f=i.diffWords(d,e);if(f.length){console.log(f);for(var g=0;g<f.length;g++){var k=f[g];if(k.removed)if(-1!==k.value.indexOf("#")){console.log("hasshtag removed ",k.value);var l=k.value.replace("#","");l=l.trim(),c.cleanModel("#",l)}else if(-1!==k.value.indexOf("$")){console.log("dollar removed ",k.value);var m=k.value.replace("$","");m=m.trim()}else if(-1!==k.value.indexOf("@")){console.log("@ removed ",k.value);var n=k.value.replace("@","");n=n.trim()}}}}}),d.on("keydown keyup",function(a){8===parseInt(a.which)&&"keydown"===a.type&&(j=!0,console.log("setting backspace pressed to true")),c.$apply(g)}),g()}}}}]),htsApp.directive("dropzone",function(){return{link:function(a,b,c){var d,e;console.log("dropzone scope:",a),Dropzone.autoDiscover=!1,d=a[c.dropzone],e=new Dropzone(b[0],d.options),angular.forEach(d.eventHandlers,function(a,b){e.on(b,a)}),d.init=function(){e.processQueue()}}}}),htsApp.directive("dropdownMultiselect",["favesFactory",function(a){return{restrict:"E",scope:{selectedlabels:"=",userlabels:"=",selectedfaves:"=",placeholder:"=ngPlaceholder"},link:function(a,b){b.bind("click",function(a){a.stopPropagation()})},template:"<span class='dropdown' dropdown><i class='fa fa-tags dropdown-toggle' dropdown-toggle ng-click='open=!open;openDropdown()'>&nbsp;&nbsp;#Label</i><ul class='dropdown-menu'>   <input ng-model='query' type='text' autofocus class='labels-input' placeholder='Filter or Create New Labels'/>   <li ng-repeat='label in userlabels | filter:query' class='label-list'>       <a ng-click='setSelectedItem()'>           <span ng-click='deleteLabel($event)' class='fa fa-minus-circle pull-left delete-label'></span>#{{label.name}}           <span ng-class='isChecked(label.name)'><span/>       </a>   </li>   <li>       <a dropdown-toggle ng-click='createNewLabel(query)' ng-show='ifQueryUnique(query)'>{{query}} (create new)</a>   </li>   <li>       <a dropdown-toggle ng-click='applyChanges()' ng-show='updatesNecessary'>Apply</a>   </li></ul></span>",controller:["$scope","favesFactory","Session",function(a,b,c){a.currentFaves=c.userObj.user_settings.favorites,a.openDropdown=function(){a.selectedlabels=[],a.updatesNecessary=!1,console.log(a);var b=a.currentFaves;angular.forEach(a.selectedfaves,function(c,d){if(c)for(i=0;i<b.length;i++)if(b[i].postingId==d&&b[i].labels)for(j=0;j<b[i].labels.length;j++){var e=b[i].labels[j];_.contains(a.selectedlabels,e)||a.selectedlabels.push(e)}})},a.ifQueryUnique=function(b){var c=!0;return b?_.find(a.userlabels,function(a){a.name==b&&(c=!1)}):c=!1,c},a.createNewLabel=function(c){var d={name:c};b.addFavoriteLabel(d),a.userlabels=b.getUserLabels(),a.setSelectedItem(d.name),a.applyChanges(),a.query=""},a.setSelectedItem=function(b){console.log("in setSElectedItem"),a.updatesNecessary=!0,b||(b=this.label.name),_.contains(a.selectedlabels,b)?a.selectedlabels=_.without(a.selectedlabels,b):a.selectedlabels.push(b)},a.applyChanges=function(){var b=a.currentFaves;console.log("looping thought selected faves",a.selectedfaves),angular.forEach(a.selectedfaves,function(c,d){if(c)for(console.log("this item selected",c,d),i=0;i<b.length;i++)b[i].postingId==d&&(console.log(b[i].postingId,d),b[i].labels=a.selectedlabels)}),c.setSessionValue("favorites",b),a.selectedfaves={},a.updatesNecessary=!1},a.deleteLabel=function(c){c.stopPropagation();var d=this.label.name,e={name:d};b.removeFavoriteLabel(e,a.refreshTable)},a.refreshTable=function(){a.userlabels=b.getUserLabels(),b.refreshTable()},a.isChecked=function(b){return _.contains(a.selectedlabels,b)?"fa fa-check pull-right":!1}}]}}]),htsApp.directive("htsFaveToggle",function(){return{restrict:"E",template:'<span ng-class="{starHighlighted: favorited, star: !favorited}" ng-click="toggleFave(result); $event.stopPropagation();" tooltip="{{tooltipMessage}}" tooltip-placement="right" tooltip-trigger="mouseenter"></span>',controller:["$scope","$element","favesFactory","Session","authModalFactory","socketio","sideNavFactory","$timeout",function(a,b,c,d,e,f,g,h){d.userObj.user_settings.loggedIn&&c.checkFave(a.result,function(b){a.favorited=b,a.tooltipMessage="please wait",a.favorited?a.tooltipMessage="Remove from watchlist":a.tooltipMessage="Add to watchlist"}),a.toggleFave=function(b){d.userObj.user_settings.loggedIn?(console.log("favorited status: ",a.favorited),console.log(b),a.favorited?c.removeFave(b,function(){a.favorited=!1,a.tooltipMessage="Add to watch list",f.leavePostingRoom(b.postingId,"inWatchList")}):c.addFave(b,function(){g.defaultMenu[2].active=!0,h(function(){g.defaultMenu[2].active=!1},250),a.favorited=!0,a.tooltipMessage="Remove from watch list",f.joinPostingRoom(b.postingId,"inWatchList")})):e.signInModal()}}]}}),angular.module("globalVars",[]).constant("ENV",{name:"staging",htsAppUrl:"https://staging.hashtagsell.com",postingAPI:"https://staging-posting-api.hashtagsell.com/v1/postings/",userAPI:"https://staging-posting-api.hashtagsell.com/v1/users/",feedbackAPI:"https://staging.hashtagsell.com/feedback",realtimePostingAPI:"https://staging-realtime-svc.hashtagsell.com/v1/postings",realtimeUserAPI:"https://staging-realtime-svc.hashtagsell.com/v1/users",groupingsAPI:"https://staging-posting-api.hashtagsell.com/v1/groupings/",annotationsAPI:"https://staging-posting-api.hashtagsell.com/v1/annotations",facebookAuth:"https://staging.hashtagsell.com/auth/facebook",twitterAuth:"https://staging.hashtagsell.com/auth/twitter",ebayAuth:"https://staging.hashtagsell.com/auth/ebay",ebayRuName:"HashtagSell__In-HashtagS-e6d2-4-sdojf",ebaySignIn:"https://signin.sandbox.ebay.com/ws/eBayISAPI.dll",fbAppId:"367471540085253"}),htsApp.factory("authModalFactory",["Session","$modal","$log","$state",function(a,b,c,d){var e={};return e.signInModal=function(a){var e=b.open({templateUrl:"/js/authModals/modals/signInModal/partials/signIn.html",controller:"signInModalController",size:"sm",keyboard:!1,backdrop:"static",resolve:{params:function(){return a}}});e.result.then(function(a){},function(b){console.log(b),"signUp"===b?d.go("signup",{redirect:a.redirect}):"forgot"===b?d.go("forgot",{redirect:a.redirect}):"signIn"===b?d.go("signin",{redirect:a.redirect}):"successful login"===b&&a.redirect?d.go(a.redirect):"successful login"!==b||a.redirect||d.go("feed"),c.info("Modal dismissed at: "+new Date)})},e.signUpModal=function(a){var e=b.open({templateUrl:"/js/authModals/modals/signUpModal/partials/signUp.html",controller:"signupModalContainer",size:"sm",keyboard:!1,backdrop:"static"});e.result.then(function(a){},function(b){"success"===b?d.go("checkemail"):"forgot"===b?d.go("forgot",{redirect:a.redirect}):"signIn"===b&&d.go("signin",{redirect:a.redirect}),c.info("Modal dismissed at: "+new Date)})},e.checkEmailModal=function(){var a=b.open({templateUrl:"/js/authModals/modals/checkEmailModal/partials/checkEmail.html",controller:"checkEmailController",size:"sm",keyboard:!1,backdrop:"static"});a.result.then(function(a){},function(a){c.info("Modal dismissed at: "+new Date)})},e.forgotPasswordModal=function(a){var e=b.open({templateUrl:"/js/authModals/modals/forgotPasswordModal/partials/forgotPassword.html",controller:"forgotPasswordController",size:"sm",keyboard:!1,backdrop:"static",resolve:{params:function(){return a}}});e.result.then(function(a){},function(b){"success"===b?d.go("checkemail"):"signUp"===b?d.go("signup",{redirect:a.redirect}):"signIn"===b&&d.go("signin",{redirect:a.redirect}),c.info("Modal dismissed at: "+new Date)})},e.resetPasswordModal=function(a,e){var f=b.open({templateUrl:"/js/authModals/modals/resetPasswordModal/partials/resetPassword.html",controller:"resetPasswordModalController",size:"sm",keyboard:!1,backdrop:"static",resolve:{token:function(){return e}}});f.result.then(function(a){},function(a){console.log(a),a.success&&d.go("signin",{redirect:"feed",email:a.email}),c.info("Modal dismissed at: "+new Date)})},e}]),htsApp.controller("checkEmailController",["$scope","$modalInstance",function(a,b){a.dismiss=function(a){b.dismiss(a)}}]),htsApp.controller("forgotPasswordController",["$scope","$modalInstance","authFactory","params",function(a,b,c,d){d.msg&&(a.message="This activation email link has already been used.  Sign in or reset your password."),a.forgotPassword=function(b){if(b){var d=a.email;c.passwordReset(d).then(function(b){b.error?a.message=b.error:b.success&&a.dismiss("success")},function(){a.message="Please contact support.  Sorry for the trouble"})}},a.dismiss=function(a){b.dismiss(a)}}]),htsApp.controller("resetPasswordModalController",["$scope","$modalInstance","authFactory","token",function(a,b,c,d){a.resetPassword=function(b){if(b){var e=a.newPassword;c.changePassword(e,d).then(function(b){console.log(b),b.error?a.message=b.error:b.success&&a.dismiss(b)},function(){a.message="Please contact support.  Sorry for the trouble"})}},a.dismiss=function(a){b.dismiss(a)}}]),htsApp.controller("signInModalController",["$scope","$modalInstance","$window","authFactory","params",function(a,b,c,d,e){e.email&&(a.email=e.email),a.loginPassport=function(b){if(b){var c=a.email,e=a.password;d.login(c,e).then(function(b){b.error?a.message=b.error:b.success&&a.dismiss("successful login")},function(){a.message="Ooops.. Login error, please contact support."})}},a.dismiss=function(a){b.dismiss(a)}}]),htsApp.controller("signupModalContainer",["$scope","$modalInstance","authFactory",function(a,b,c){a.signupPassport=function(b){if(b){var d=a.email,e=a.password_verify,f=a.name,g=a.secret;c.signUp(d,e,f,g).then(function(b){console.log(b),b.error?a.message=b.error:b.success&&a.dismiss("success")},function(){alert("signup error")})}},a.dismiss=function(a){b.dismiss(a)}}]),htsApp.factory("authFactory",["$http","Session","$q","$window",function(a,b,c){var d={};return d.login=function(d,e){var f=c.defer();return a.post("/login",{email:d,password:e}).then(function(a){a.data.success?(b.create(a.data),console.log("PASSPORT RESPONSE",a),f.resolve(a.data)):f.resolve(a.data)},function(a,b,c,d){f.reject()}),f.promise},d.signUp=function(b,d,e,f){var g=c.defer();return a.post("/signup",{email:b,password:d,name:e,secret:f}).then(function(a){a.data&&g.resolve(a.data)},function(a,b,c,d){g.reject()}),g.promise},d.passwordReset=function(b){var d=c.defer();return a.post("/forgot",{email:b}).then(function(a){a.data&&d.resolve(a.data)},function(a,b,c,e){d.reject()}),d.promise},d.changePassword=function(b,d){var e=c.defer();return a.post("/reset",{password:b,token:d}).then(function(a){a.data&&e.resolve(a.data)},function(a,b,c,d){e.reject()}),e.promise},d.updatePassword=function(b,d){var e=c.defer();return a.post("/reset",{currentPassword:b,newPassword:d}).then(function(a){a.data&&e.resolve(a.data)},function(a,b,c,d){e.reject()}),e.promise},d}]),htsApp.controller("awesomeBarController",["$window","$scope","$location","awesomeBarFactory","searchFactory","$state",function(a,b,c,d,e,f){function g(a){var b=document.createElement("DIV");return b.innerHTML=a,b.textContent||b.innerText||""}b.clearedPlaceholder=!1,b.clearPlaceholder=function(){b.clearedPlaceholder||(console.log("clearing placeholder"),b.queryObj.q="",b.clearedPlaceholder=!0)},b.queryObj=d.queryObj,b.awesomeBarSubmit=function(){if(b.queryObj.q){console.log("before sanatize",b.queryObj),e.resetResultsView();var a=b.queryObj.q,c=g(b.queryObj.q);console.log("stripped html",c);var d=c.replace("@"+b.queryObj.city,"").trim();console.log("trimmed string",d),b.queryObj.q=d,console.log("after sanatize",b.queryObj),f.go("results",b.queryObj),b.queryObj.q=a}},b.validateQueryObj=function(){b.queryObj.locationObj&&-1===b.queryObj.q.indexOf("@")&&(b.queryObj.city=null,b.queryObj.locationObj=null)},b.map=d.googleMap,b.searchPlaces=function(a){a&&d.predictPlace(a).then(function(a){b.cities=a})},b.getCityMetaData=function(a){return d.getCityMetaData(a).then(function(c){b.queryObj.city=a.description,b.queryObj.locationObj=c}),'<span class="mention-highlighter-location" contentEditable="false">@'+a.description+"</span>"}}]),htsApp.factory("awesomeBarFactory",["$q","$http","$stateParams",function(a,b,c){var d={};return d.queryObj={q:c.q||"I'm searching for...",city:null,locationObj:null},d.googleMap=new google.maps.Map(document.createElement("map-canvas")),d.predictPlace=function(b){var c=new google.maps.LatLngBounds(new google.maps.LatLng(37.79738,-122.52464),new google.maps.LatLng(37.68879,-122.36122)),d={input:b,bounds:c,componentRestrictions:{country:"US"}},e=new google.maps.places.AutocompleteService,f=a.defer();return e.getPlacePredictions(d,function(a,b){f.resolve(a)}),f.promise},d.getCityMetaData=function(b){var c=new google.maps.places.PlacesService(d.googleMap),e={placeId:b.place_id},f=a.defer();return c.getDetails(e,function(a,b){f.resolve(a)}),f.promise},d}]),htsApp.controller("categorySelectorBar",["$scope","$rootScope","Session","ivhTreeviewMgr","authModalFactory","categoryFactory",function(a,b,c,d,e,f){function g(a){return a.replace(/\w\S*/g,function(a){return a.charAt(0).toUpperCase()+a.substr(1).toLowerCase()})}b.$on("$stateChangeSuccess",function(b,c,d,e,f){"feed"===c.name||"feed.splash"===c.name?a.showCategorySelectorBar=!0:a.showCategorySelectorBar=!1}),a.feedCategoryObj={},a.feedCategoryObj.userDefaultCategories=c.userObj.user_settings.feed_categories,a.getAllCategoriesFromServer=function(){f.lookupCategories().then(function(b){200!==b.status?console.log(b.data.error):200===b.status&&(a.feedCategoryObj.nestedCategories=h(b.data.results),console.log(a.feedCategoryObj.nestedCategories))},function(a){console.log(a),console.log("category lookup error")})},a.getAllCategoriesFromServer();var h=function(a){for(var b=c.userObj.user_settings.safe_search,e=[],f=0;f<a.length;f++){var h=a[f];switch(h.code){case"SSSS":case"VVVV":case"RRRR":case"MMMM":case"PPPP":if(b&&"PPPP"===h.code||b&&"MMMM"===h.code)continue;h.name=g(h.name),h.selected=i(h.code);for(var j=0;j<h.categories.length;j++){var k=h.categories[j];k.name=g(k.name),k.selected=i(k.code),k.selected&&(h.selected=!0)}e.push(h)}}return d.validate(e),console.log(e),e},i=function(b){for(var c=0;c<a.feedCategoryObj.userDefaultCategories.length;c++){if(a.feedCategoryObj.userDefaultCategories[c].code===b)return!0;if(c===a.feedCategoryObj.userDefaultCategories.length-1)return!1}};a.categoryOnChange=function(b,f,g){if(console.log(b,f,g),c.userObj.user_settings.loggedIn){var h=[];for(t=0;t<g.length;t++)if(g[t].selected)h.push({name:g[t].name,code:g[t].code});else for(u=0;u<g[t].categories.length;u++)g[t].categories[u].selected&&h.push({name:g[t].categories[u].name,code:g[t].categories[u].code});console.log(h),c.setSessionValue("feed_categories",h,function(a){200!==a.status&&alert("could not remove category from user feed.  please notify support.")})}else d.deselect(a.feedCategoryObj.nestedCategories,b.name,!1),e.signInModal()},a.expandTree=function(){d.expandRecursive(a.feedCategoryObj.nestedCategories)},a.$watch("filterCategories",function(b,c){""===b&&d.collapseRecursive(a.feedCategoryObj.nestedCategories)})}]),htsApp.controller("feed.controller",["$scope","feedFactory","splashFactory","$state","$interval",function(a,b,c,d,e){a.status=b.status,a.testing=function(a){console.log(a)};var f=function(){if(a.currentDate=Math.floor(Date.now()/1e3),!a.results&&b.persistedResults){console.log("recovering from persisted results",b.persistedResults),a.results=b.persistedResults;var c=!0}else a.results||(b.status.pleaseWait=!0);b.poll().then(function(d){if(200!==d.status)a.status.pleaseWait=!1,a.status.error.message=":( Oops.. Something went wrong.",a.status.error.trace=d.data.error;else if(200===d.status)if(!a.results||c){for(i=0;i<d.data.external.postings.length;i++){var g=d.data.external.postings[i];if(0===g.images.length)g.feedItemHeight=179;else if(1===g.images.length)g.feedItemHeight=261,"CRAIG"===g.username&&(g.images[0].full&&(g.images[0].full=g.images[0].full.replace(/^http:\/\//i,"//")),g.images[0].thumb&&(g.images[0].thumb=g.images[0].thumb.replace(/^http:\/\//i,"//")),g.images[0].images&&(g.images[0].images=g.images[0].images.replace(/^http:\/\//i,"//")));else if(g.feedItemHeight=420,"CRAIG"===g.username)for(var h=0;h<g.images.length;h++){var j=g.images[h];j.full&&(j.full=j.full.replace(/^http:\/\//i,"//")),j.thumb&&(j.thumb=j.thumb.replace(/^http:\/\//i,"//")),j.images&&(j.images=j.images.replace(/^http:\/\//i,"//"))}c&&a.results.unshift(g)}b.status.pleaseWait=!1,c||(a.results=d.data.external.postings),b.persistedResults=a.results.slice(0,300),c=!1;var k=e(f,6e4,0,!0);a.$on("$destroy",function(){e.cancel(k)})}else{var l=jQuery(".inner-container").scrollTop();for(i=0;i<d.data.external.postings.length;i++)0===d.data.external.postings[i].images.length?(d.data.external.postings[i].feedItemHeight=179,l+=179):1===d.data.external.postings[i].images.length?(d.data.external.postings[i].feedItemHeight=216,l+=216):(d.data.external.postings[i].feedItemHeight=420,l+=420),a.results.unshift(d.data.external.postings[i]);jQuery(".inner-container").scrollTop(l),b.persistedResults=a.results.slice(0,300),console.log("persisted results are: ",b.persistedResults)}},function(a){console.log(a)})};f(),a.openSplash=function(a){c.result=a.result,console.log(c.result),d.go("feed.splash",{id:a.result.postingId})},a.$on("$stateChangeStart",function(a,c,d,e,f){b.resetFeedView()})}]),htsApp.filter("secondsToTimeString",function(){return function(a){var b=Math.floor(a/86400),c=Math.floor(a%86400/3600),d=Math.floor(a%86400%3600/60),e="";return b>0&&(e+=b>1?b+" days ":b+" day "),c>0&&(e+=c>1?c+" hours ":c+" hour "),d>=0&&(e+=d>1?d+" minutes ":d+" minute "),e}}),htsApp.factory("feedFactory",["$http","$stateParams","$location","$q","Session",function(a,b,c,d,e){var f={};return f.status={pleaseWait:!0,error:{}},f.queryParams={},f.poll=function(){var b=d.defer(),g="",h="",j="";for(i=0;i<e.userObj.user_settings.feed_categories.length;i++)"AAAA"==e.userObj.user_settings.feed_categories[i].code||"CCCC"==e.userObj.user_settings.feed_categories[i].code||"DISP"==e.userObj.user_settings.feed_categories[i].code||"SSSS"==e.userObj.user_settings.feed_categories[i].code||"JJJJ"==e.userObj.user_settings.feed_categories[i].code||"MMMM"==e.userObj.user_settings.feed_categories[i].code||"PPPP"==e.userObj.user_settings.feed_categories[i].code||"RRRR"==e.userObj.user_settings.feed_categories[i].code||"SVCS"==e.userObj.user_settings.feed_categories[i].code||"ZZZZ"==e.userObj.user_settings.feed_categories[i].code||"VVVV"==e.userObj.user_settings.feed_categories[i].code?h+=e.userObj.user_settings.feed_categories[i].code+"|":j+=e.userObj.user_settings.feed_categories[i].code+"|";return e.userObj.user_settings.safe_search&&(h+="~PPPP|~MMMM"),g=c.protocol()+"://"+c.host()+":"+c.port()+"/userfeed?category_group="+h+"&category="+j,f.queryParams.anchor&&(g+="&anchor="+f.queryParams.anchor,g+="&cityCode="+f.queryParams.cityCode),a({method:"GET",url:g}).then(function(a,c,d,e){console.log("polling response",a),a.data.error?(f.status.pleaseWait=!1,f.status.error.message=":( Oops.. Something went wrong.",f.status.error.trace=a.data.error.response.error,b.reject(a)):(f.queryParams.anchor=a.data.external.anchor,f.queryParams.cityCode=a.data.location.cityCode,b.resolve(a))},function(a,c,d,e){b.reject(a)}),b.promise},f.resetFeedView=function(){f.status.error={}},f}]),htsApp.controller("feedbackController",["$scope","feedbackFactory","$http","ENV","Notification",function(a,b,c,d,e){a.feedback=b.feedback,a.submitFeedback=function(){console.log(a.feedback),c.post(d.feedbackAPI,a.feedback).success(function(b){b.success?(a.feedback.form.visible=!1,a.feedback.form.generalFeedback=null,e.success({title:"Feedback Sent!",message:"You'll receive an email shortly.",delay:6e3})):b.error&&e.error({title:"Could not submit your feedback",message:b.error,delay:1e4})}).error(function(a){e.error({title:"Could not submit your feedback",message:"Sorry! Something is big time wrong. Email us at feedback@hashtagsell.com.",delay:1e4})})}}]),htsApp.factory("feedbackFactory",["Session",function(a){var b={};return b.feedback={form:{user:a.userObj.user_settings.name,generalFeedback:null,visible:!1}},b}]),htsApp.controller("filterBar",["$scope","$rootScope","searchFactory","$timeout","sideNavFactory",function(a,b,c,d,e){b.$on("$stateChangeSuccess",function(b,c,d,e,f){"results"===c.name||"results.splash"===c.name?a.showFilterBar=!0:a.showFilterBar=!1}),a.filterToggles=c.filter,a.$watchGroup(["filterToggles.mustHaveImage","filterToggles.mustHavePrice"],function(b,d,e){console.log(a.filterToggles),c.filterArray(a.views,"filter")}),a.views=c.views,a.$watchGroup(["views.gridView","views.showMap"],function(){"results"===b.currentState&&d(function(){c.filterArray(a.views,"resize"),a.views.gridView?e.sideNav.listView=!1:!a.views.gridView&&a.views.showMap?e.sideNav.listView=!1:a.views.gridView||a.views.showMap||(e.sideNav.listView=!0)},1)}),a.rangeSlider=c.priceSlider,console.log(a.rangeSlider),a.slideDelegate=function(b){console.log(b),c.priceSlider.userSetValue=!0,console.log(c.priceSlider),c.filterArray(a.views,"filter")},a.myFormatter=function(a){return"$"+a}}]),htsApp.controller("myFavesController",["$scope","$window","favesFactory","splashFactory","$state","ngTableParams","$filter","Session","quickComposeFactory","$modal","$log",function(a,b,c,d,e,f,g,h,j,k,l){a.currentFaves=h.userObj.user_settings.favorites,0===a.currentFaves.length&&(a.noItems=!0),c.tableParams=new f({page:1,count:2e3,filter:{},sorting:{}},{counts:[],total:a.currentFaves.length,getData:function(b,d){var e=g("filter")(a.currentFaves,c.filterString),f=d.sorting()?g("orderBy")(e,d.orderBy()):e;d.total(f.length),b.resolve(f.slice((d.page()-1)*d.count(),d.page()*d.count()))}}),a.tableParams=c.tableParams,a.tableParams.settings().$scope=a,a.$on("$stateChangeSuccess",function(b,c,d,e,f){a.currentState=c.name,a.expandedPostingId=d.postingId}),a.removeFave=function(a){c.removeFave(a,function(){c.refreshTable()})},a.checkboxes={checked:!1,items:{}},a.$watch("checkboxes.items",function(b){if(a.currentFaves){var c=0,d=0;totalFaves=a.currentFaves.length,angular.forEach(a.currentFaves,function(b){c+=a.checkboxes.items[b.postingId]||0,d+=!a.checkboxes.items[b.postingId]||0}),console.log("checked: ",c,"unchecked: ",d),(0===d&&0!==totalFaves||0===c&&0!==totalFaves)&&(a.checkboxes.masterCheck=c==totalFaves),0===c||0===totalFaves?a.checkboxes.checked=!1:a.checkboxes.checked=!0,angular.element(document.getElementById("select_all")).prop("indeterminate",0!==c&&0!==d)}},!0),a.$watch("checkboxes.masterCheck",function(b){angular.forEach(a.currentFaves,function(c){angular.isDefined(c.postingId)&&(a.checkboxes.items[c.postingId]=b)})}),a.filters={$:""},a.$watch("filters.$",function(b){c.filterString=b,console.log(c.filterString),a.tableParams.reload()}),a.batchRemoveFaves=function(b){c.batchRemoveFaves(b),a.checkboxes={checked:!1,items:{}}},a.batchEmail=function(b){var c=a.currentFaves,d=[];if(angular.forEach(b.items,function(a,b){if(a)for(console.log("this item selected",a,b),i=0;i<c.length;i++)c[i].postingId==b&&d.push(c[i])}),console.log(d),"ask"===h.userObj.user_settings.email_provider[0].value){var e=k.open({templateUrl:"/js/transactionButtons/modals/email/partials/transactionButtons.modal.email.partial.html",controller:"quickComposeController",resolve:{result:function(){return d}}});e.result.then(function(a){},function(a){console.log(a),"signUp"===a&&authModalFactory.signUpModal(),l.info("Modal dismissed at: "+new Date)})}else j.generateMailTo(h.userObj.user_settings.email_provider[0].value,d)},a.UserLabels=c.getUserLabels(),a.selected_labels=[],a.preselected={name:[]},a.removeIndividualLabel=function(a){event.stopPropagation(),alert("Quick remove label feature soon.  Please check the item and remove the label for now.")},a.openSplash=function(a){d.result=a,console.log(d.result),e.go("watchlist.splash",{id:a.postingId})}}]),htsApp.factory("favesFactory",["Session","myPostsFactory",function(a,b){var c={};return c.currentFavorites=a.userObj.user_settings.favorites,
c.addFave=function(c,d){var e=_.some(a.userObj.user_settings.favorites,function(a){return a.postingId===c.postingId});e||("HSHTG"===c.external.source.code?b.getPostingIdQuestionsAndOffers(c.postingId).then(function(b){var c=b.data;a.userObj.user_settings.favorites.push(c),a.setSessionValue("favorites",a.userObj.user_settings.favorites,d)}):(a.userObj.user_settings.favorites.push(c),a.setSessionValue("favorites",a.userObj.user_settings.favorites,d)))},c.removeFave=function(b,c){var d=a.userObj.user_settings.favorites,e=[];_.some(d,function(a){a.postingId==b.postingId&&e.push(d.indexOf(a))}),e.length>0&&(d.splice(e[0],1),a.setSessionValue("favorites",d,c))},c.updateFavorite=function(d,e){var f=a.userObj.user_settings.favorites;console.log("emitted favorite object",d),console.log("currentFavorites",f);for(var g,h=0;h<f.length;h++){var i=f[h];if(console.log(i.postingId,d.posting.postingId),i.postingId===d.posting.postingId){g=h;break}}console.log("done with loop"),g>=0&&(console.log("here is matching favorite"),console.log(f[g]),b.getPostingIdQuestionsAndOffers(d.posting.postingId).then(function(b){var d=b.data;a.userObj.user_settings.favorites[g]=d;try{c.refreshTable()}catch(f){console.log(f)}finally{a.setSessionValue("favorites",a.userObj.user_settings.favorites,e)}}))},c.checkFave=function(b,c){var d=a.userObj.user_settings.favorites,e=[];_.some(d,function(a){a.postingId==b.postingId&&e.push(d.indexOf(a))}),c(e.length>0?!0:!1)},c.refreshTable=function(){console.log("refreshing favorites table"),c.tableParams.reload()},c.filterString="",c.batchRemoveFaves=function(a){console.log(a),angular.forEach(a.items,function(a,b){if(console.log("checked: ",a,"id: ",b),a){var d={};d.postingId=b,c.removeFave(d,function(){c.refreshTable()})}})},c.addFavoriteLabel=function(b){var c=a.userObj;c.user_settings.user_labels||(c.user_settings.user_labels=[]),c.user_settings.user_labels.push(b),a.setSessionValue("user_labels",c.user_settings.user_labels)},c.removeFavoriteLabel=function(b,c){var d=a.userObj;d.user_settings.user_labels=_.without(d.user_settings.user_labels,_.findWhere(d.user_settings.user_labels,b)),a.setSessionValue("user_labels",d.user_settings.user_labels);var e=[];_.each(d.user_settings.favorites,function(a){a.labels=_.without(a.labels,_.findWhere(a.labels,b.name)),e.push(a)}),d.user_settings.favorites=e,a.setSessionValue("favorites",d.user_settings.favorites,c)},c.getUserLabels=function(){return a.getSessionValue("user_labels")},c}]),htsApp.controller("watchlist.offers.controller",["$scope","Session","offersFactory","Notification",function(a,b,c,d){a.userObj=b.userObj,a.toggled=function(a){console.log("Dropdown is now: ",a)},a.cancelOffer=function(a){var b=a.postingId,e=a.offerId;c.deleteOffer(b,e).then(function(a){console.log(a),204===a.status||d.error({title:a.name,message:a.message,delay:2e4})},function(a){console.log(a),d.error({title:a.data.name,message:a.data.message,delay:2e4})})}}]),htsApp.directive("senderOffersMoreInfo",function(){return{restrict:"E",scope:{post:"="},templateUrl:"js/interested/offers/partials/watchlist.offers.html",controller:"watchlist.offers.controller"}}),htsApp.controller("watchlist.questions.controller",["$scope","qaFactory","$state","Notification","myPostsFactory","Session",function(a,b,c,d,e,f){console.log("watchlist.questions.controller"),a.userObj=f.userObj,a.showAnswered=!1,a.toggled=function(a){console.log("Dropdown is now: ",a)},a.deleteQuestion=function(a,c){console.log(a,c),b.deleteQuestion(a,c).then(function(a){200===a.status?e.getAllUserPosts(f.userObj.user_settings.name):d.error({title:a.name,message:a.message})},function(a){})}}]),htsApp.directive("senderQuestionsMoreInfo",function(){return{restrict:"E",scope:{post:"="},templateUrl:"js/interested/questions/partials/watchlist.questions.html",controller:"watchlist.questions.controller"}}),htsApp.factory("watchlistQuestionsFactory",["$http","$rootScope","ENV","$q","utilsFactory",function(a,b,c,d,e){var f={};return f.questions={store:[]},f.getPostingIdQuestions=function(b){var g=d.defer(),h={postingId:b,questions:!0,count:100};return a({method:"GET",url:c.postingAPI+b+e.bracketNotationURL(h)}).then(function(a,b,c,d){200===a.status?(f.questions.store=a.data.questions.results,g.resolve(a)):g.reject(a)},function(a,b,c,d){g.reject(a)}),g.promise},f.submitQuestion=function(b,e,g){var h=d.defer(),i=e.postingId,j={username:g,value:b};return a({method:"POST",url:c.postingAPI+i+"/questions",data:j}).then(function(a,b,c,d){f.getPostingIdQuestions(i).then(function(a){h.resolve(a)},function(a){h.reject(a)})},function(a,b,c,d){h.reject(a)}),h.promise},f.deleteQuestion=function(b,e){var g=d.defer();return a({method:"DELETE",url:c.postingAPI+b+"/questions/"+e}).then(function(a,c,d,e){f.getPostingIdQuestions(b).then(function(a){g.resolve(a)},function(a){g.reject(a)})},function(a,b,c,d){g.reject(a)}),g.promise},f.deleteAnswer=function(b,e,g){var h=d.defer();return a({method:"DELETE",url:c.postingAPI+b+"/questions/"+e+"/answers/ "+g}).then(function(a,c,d,e){f.getPostingIdQuestions(b).then(function(a){h.resolve(a)},function(a){h.reject(a)})},function(a,b,c,d){h.reject(a)}),h.promise},f}]),htsApp.controller("mainController",["$scope","$rootScope","sideNavFactory","$timeout","Session","socketio","myPostsFactory","favesFactory",function(a,b,c,d,e,f,g,h){a.userObj=e.userObj,a.sideNav=c.sideNav,a.toggleOffCanvasSideNav=function(){a.sideNav.hidden=!a.sideNav.hidden},b.$on("$stateChangeStart",function(c,e,f,g,h){if(b.previousState=g.name,b.currentState=e.name,console.log("Previous state:"+b.previousState),console.log("Current state:"+b.currentState),"feed.splash"!==b.currentState&&"results.splash"!==b.currentState&&("feed"===b.currentState?a.sideNav.listView=!0:"results.splash"===b.previousState||"feed.splash"===b.previousState?console.log("do nothing"):a.sideNav.listView=!1),a.sideNav.hidden=!0,"results"===e.name)d(function(){var a,b=angular.element(document.getElementsByClassName("navbar-fixed-top")),c=angular.element(document.getElementsByClassName("inner-container")),d=angular.element(document.getElementsByClassName("sidebar-container")),e=0,f=!1,g=function(){return a=c.scrollTop(),a>e?(e=a,!1):(e=a,!0)};c.on("scroll",function(){var a=g(),e=c.scrollTop();f&&a?(b.removeClass("hide-navbar"),d.removeClass("sidebar-container-roll-up"),f=!1):e>=50&&!f&&!a&&(b.addClass("hide-navbar"),d.addClass("sidebar-container-roll-up"),f=!0)})},250);else{var i=angular.element(document.getElementsByClassName("navbar-fixed-top")),j=angular.element(document.getElementsByClassName("sidebar-container"));i.removeClass("hide-navbar"),j.removeClass("sidebar-container-roll-up")}}),a.userObj.user_settings.loggedIn&&e.getUserFromServer().then(function(a){e.create(a)}),a.$watch("userObj.user_settings.loggedIn",function(a,b){if(a)f.init(e.userObj.user_settings.name),g.getAllUserPosts(e.userObj.user_settings.name).then(function(a){for(var b=0;b<g.userPosts.data.length;b++){var c=g.userPosts.data[b];f.joinPostingRoom(c.postingId,"postingOwner")}}),_.each(h.currentFavorites,function(a){f.joinPostingRoom(a.postingId,"inWatchList")});else if(f.cachedUsername){if(f.closeAllConnections(),g.userPosts.data.length)for(var c=0;c<g.userPosts.data.length;c++){var d=g.userPosts.data[c];f.leavePostingRoom(d.postingId,"postingOwner")}_.each(h.currentFavorites,function(a){f.leavePostingRoom(a.postingId,"inWatchList")})}},!0)}]),htsApp.factory("messagesFactory",function(){var a={};return a.newMessageNotification=function(a){console.log('%s said "%s" at %s in room %s',a.username,a.message,a.timestamp,a.recipient)},a}),htsApp.controller("metaController",["$scope","metaFactory",function(a,b){a.metatags=b.metatags}]),htsApp.factory("metaFactory",["ENV",function(a){var b={};return b.metatags={page:{title:"HashtagSell · Rethinking Online Classifieds",description:"HashtagSell.com is rethinking the way people buy and sell online.  Search millions of online classifieds in seconds!  Sell your next item with HashtagSell.com.",googleVerification:"QEL7PxohhyFKyG5zg8Utt8ohbB_HzYjdYUnDXdhFBt0",faviconUrl:"https://static.hashtagsell.com/htsApp/favicon/favicon.ico"},facebook:{title:"HashtagSell Online Classifieds",image:"https://static.hashtagsell.com/logos/hts/HashtagSell_Logo_Home.svg",site_name:"HashtagSell.com",description:"HashtagSell.com is rethinking the way people buy and sell online.  Search millions of online classifieds in seconds!  Sell your next item with HashtagSell.com.",url:a.htsAppUrl},twitter:{card:"summary",domain:"hashtagsell.com",site:"@hashtagsell",description:"HashtagSell.com is rethinking the way people buy and sell online.  Search millions of online classifieds in seconds!  Sell your next item with HashtagSell.com.",title:"HashtagSell.com - Rethinking Online Classifieds",url:a.htsAppUrl,creator:"",image:"https://static.hashtagsell.com/logos/hts/HashtagSell_Logo_Home.svg",appIdiPhone:"",appIdiPad:"",appIdGooglePlay:"",appUrliPhone:"",appUrliPad:"",appUrlGooglePlay:""}},b}]),htsApp.controller("myPosts.controller",["$scope","$filter","$modal","myPostsFactory","Session","socketio","ngTableParams","newPostFactory","Notification","splashFactory","$state",function(a,b,c,d,e,f,g,h,i,j,k){a.userPosts=d.userPosts,console.log(a.userPosts),d.tableParams=new g({page:1,count:2e3,filter:{},sorting:{}},{counts:[],total:a.userPosts.data.length,getData:function(c,e){var f=b("filter")(a.userPosts.data,d.filterString),g=e.sorting()?b("orderBy")(f,e.orderBy()):f;e.total(g.length),c.resolve(g.slice((e.page()-1)*e.count(),e.page()*e.count()))}}),a.tableParams=d.tableParams,a.tableParams.settings().$scope=a,a.filters={$:""},a.$watch("filters.$",function(b){d.filterString=b,console.log(d.filterString),a.tableParams.reload()}),a.$on("$stateChangeSuccess",function(b,c,d,e,f){a.currentState=c.name,a.expandedPostingId=d.postingId}),a.newPost=function(){var b=c.open({templateUrl:"/js/newPost/modals/newPost/partials/newpost.html",controller:"newPostModal",size:"lg",resolve:{mentionsFactory:function(){return h}}});b.result.then(function(b){a.modalContent.selected=b},function(){console.log("Modal dismissed at: "+new Date)})},a.countUnreadQuestions=function(a){for(var b=0,c=0;c<a.questions.results.length;c++){var d=a.questions.results[c];d.answers.length||b++}return b},a.countUnreadOffers=function(a){for(var b=0,c=0;c<a.offers.results.length;c++){var d=a.offers.results[c];b++;for(var e=0;e<d.proposedTimes.length;e++){var f=d.proposedTimes[e];f.acceptedAt&&b--}}return b},a.deletePost=function(a){console.log(a),d.deletePost(a).then(function(b){204===b.status?(f.leavePostingRoom(a.postingId,"postingOwner"),d.getAllUserPosts(e.userObj.user_settings.name).then(function(a){200===a.status||(i.error({title:"Whoops",message:"Please notify support.  We coulnd't refresh your myPosts list after deleting an item.",delay:1e4}),alert("could not refresh myPost list after deleting item.  contact support."))})):i.error({title:"Whoops",message:"Please notify support.  We coulnd't delete your item for some reason.",delay:1e4})})},a.editPost=function(a){i.error({title:"Coming soon",message:"Please delete and recreate the ad for now.  We're rolling out edit functionality soon! :)",delay:1e4})},a.openSplash=function(a){j.result=a,console.log(j.result),k.go("myposts.splash",{id:a.postingId})}}]),htsApp.factory("myPostsFactory",["$http","ENV","$q","utilsFactory","sideNavFactory","profileFactory",function(a,b,c,d,e,f){var g={};return g.userPosts={data:[],updateMyPostsBadgeCount:function(){var a=0;if(this.data.length)for(var b=0;b<this.data.length;b++){var c=this.data[b];if(c.questions.results.length)for(var d=0;d<c.questions.results.length;d++){var f=c.questions.results[d];f.answers.length||a++}if(c.offers.results.length)for(var g=0;g<c.offers.results.length;g++){var h=c.offers.results[g];a++;for(var i=0;i<h.proposedTimes.length;i++){var j=h.proposedTimes[i];j.acceptedAt&&a--}}}return e.items[1].alerts=a,a}},g.getAllUserPosts=function(f){var h=c.defer(),i={filters:{mandatory:{exact:{username:f}}}};return a({method:"GET",url:b.postingAPI+d.bracketNotationURL(i)}).then(function(a){var b=a.data.results;if(b.length){g.userPosts.data.length&&(g.userPosts.data=[]);for(var c=0;c<b.length;c++){var d=b[c];g.getPostingIdQuestionsAndOffers(d.postingId).then(function(a){var c=a.data;g.userPosts.data.push(c),g.userPosts.updateMyPostsBadgeCount(),g.userPosts.data.length===b.length&&(g.tableParams&&g.tableParams.reload(),console.log(f+" items for sale:",g.userPosts),h.resolve(a))})}}else g.userPosts.data=[],e.items[1].alerts=0},function(a){h.reject(a)}),h.promise},g.getPostingIdQuestionsAndOffers=function(e){var g=c.defer(),h={postingId:e,questions:!0,offers:!0,count:100};return a({method:"GET",url:b.postingAPI+e+d.bracketNotationURL(h)}).then(function(a,b,c,d){if(200===a.status){if(a.data.questions.results.length)for(var e=0,h=0;h<a.data.questions.results.length;h++)f.getUserProfile(a.data.questions.results[h].username).then(function(b){e++,200===b.status&&(a.data.questions.results[e-1].userProfile=b.data.user),e===a.data.questions.results.length&&(a.data.offers.results.length||g.resolve(a))});if(a.data.offers.results.length)for(var i=0,j=0;j<a.data.offers.results.length;j++)f.getUserProfile(a.data.offers.results[j].username).then(function(b){i++,200===b.status&&(a.data.offers.results[i-1].userProfile=b.data.user),i===a.data.offers.results.length&&g.resolve(a)});else g.resolve(a)}else g.reject(a)},function(a,b,c,d){g.reject(a)}),g.promise},g.deletePost=function(d){var e=c.defer();return a({method:"DELETE",url:b.postingAPI+d.postingId}).then(function(a,b,c,d){console.log("delete response: ",a),e.resolve(a)},function(a,b,c,d){e.reject(a)}),e.promise},g}]),htsApp.controller("myPosts.offers.controller",["$scope","offersFactory","myPostsFactory","socketio","$state","Session","Notification",function(a,b,c,d,e,f,g){function h(a){return!a||/^\s*$/.test(a)}a.userObj=f.userObj,a.acceptOffer=function(a){var e=a.postingId,i=a.offerId,j=a.response;b.acceptOffer(e,i,j).then(function(b){if(201===b.status){var e=a.username;h(a.message)||d.sendMessage(e,a.message),c.getAllUserPosts(f.userObj.user_settings.name)}else console.log(b),g.error({title:b.name,message:b.message,delay:2e4})},function(a){console.log(a),g.error({title:a.data.name,message:a.data.message,delay:2e4})})},a.declineOffer=function(a){var e=a.postingId,i=a.offerId;b.deleteOffer(e,i).then(function(b){if(console.log(b),204===b.status){var e=a.username;h(a.message)?d.sendMessage(e,a.response):d.sendMessage(e,a.message),c.getAllUserPosts(f.userObj.user_settings.name)}else g.error({title:b.name,message:b.message,delay:2e4})},function(a){g.error({title:"Contact Support",message:"Failed to decline the offer.  Error:"+a,delay:2e4})})}}]),htsApp.directive("ownerOffersMoreInfo",function(){return{restrict:"E",scope:{post:"="},templateUrl:"js/myPosts/offers/partials/myPosts.offers.html",controller:"myPosts.offers.controller"}}),htsApp.factory("offersFactory",["$http","$rootScope","$q","ENV","Session",function(a,b,c,d,e){var f={};return f.newOfferNotification=function(a){console.log("%s placed an %s offers on postingId %s to meet @ %s around %s",a.username,a.proposedTimes.length,a.postingId,a.proposedTimes[0].where,a.proposedTimes[0].when),console.log(a)},f.sendOffer=function(b,e){console.log("sending this offer",e);var f=c.defer();return a({method:"POST",url:d.postingAPI+b+"/offers",data:e}).then(function(a,b,c,d){f.resolve(a)},function(a,b,c,d){f.reject(a)}),f.promise},f.acceptOffer=function(b,e,f){console.log("postingId",b),console.log("offerId",e),console.log("accepting this offer",f);var g=c.defer();return a({method:"POST",url:d.postingAPI+b+"/offers/"+e+"/accept",data:f}).then(function(a,b,c,d){g.resolve(a)},function(a,b,c,d){g.reject(a)}),g.promise},f.deleteOffer=function(b,e){console.log("Deleting offer",b,e);var f=c.defer();return a({method:"DELETE",url:d.postingAPI+b+"/offers/"+e}).then(function(a,b,c,d){f.resolve(a)},function(a,b,c,d){f.reject(a)}),f.promise},f}]),htsApp.controller("myPosts.questions.controller",["$scope","qaFactory","$state","Notification","myPostsFactory","Session",function(a,b,c,d,e,f){a.userObj=f.userObj,a.showAnswered=!1,a.toggled=function(a){console.log("Dropdown is now: ",a)},a.submitAnswer=function(c,f){var g={username:c.username,value:c.givenAnswer};b.submitAnswer(c.postingId,c.questionId,g).then(function(b){201===b.status?(console.log(b),e.getAllUserPosts(a.userObj.user_settings.name).then(function(a){})):d.error({title:b.name,message:b.message})},function(a){})},a.deleteQuestion=function(e,f,g){b.deleteQuestion(e,f).then(function(b){204===b.status?(a.post.questions.results.splice(g,1),a.post.questions.results.length||c.go("^")):d.error({title:b.name,message:b.message})},function(a){})},a.updateAnswer=function(b){a.deleteAnswer(b),a.submitAnswer()},a.deleteAnswer=function(c){var d=a.question.postingId,e=a.question.questionId;b.deleteAnswer(d,e,c).then(function(a){},function(a){})}}]),htsApp.directive("ownerQuestionsMoreInfo",function(){return{restrict:"E",scope:{post:"="},templateUrl:"js/myPosts/questions/partials/myPosts.questions.html",controller:"myPosts.questions.controller"}}),htsApp.factory("qaFactory",["$http","$rootScope","ENV","$q","utilsFactory",function(a,b,c,d,e){var f={};return f.questions={store:[]},f.getPostingIdQuestions=function(b){var g=d.defer(),h={postingId:b,questions:!0,count:100};return a({method:"GET",url:c.postingAPI+b+e.bracketNotationURL(h)}).then(function(a,b,c,d){200===a.status?(f.questions.store=a.data.questions.results,g.resolve(a)):g.reject(a)},function(a,b,c,d){g.reject(a)}),g.promise},f.submitQuestion=function(b,e,g){var h=d.defer(),i=e.postingId,j={username:g,value:b};return a({method:"POST",url:c.postingAPI+i+"/questions",data:j}).then(function(a,b,c,d){201===a.status?(f.questions.store.unshift(a.data),h.resolve(a)):h.reject(a)},function(a,b,c,d){h.reject(a)}),h.promise},f.submitAnswer=function(b,e,f){var g=d.defer();return a({method:"POST",url:c.postingAPI+b+"/questions/"+e+"/answers",data:f}).then(function(a,b,c,d){g.resolve(a)},function(a,b,c,d){g.reject(a)}),g.promise},f.deleteQuestion=function(b,e){var f=d.defer();return a({method:"DELETE",url:c.postingAPI+b+"/questions/"+e}).then(function(a,b,c,d){f.resolve(a)},function(a,b,c,d){f.reject(a)}),f.promise},f.deleteAnswer=function(b,e,g){var h=d.defer();return a({method:"DELETE",url:c.postingAPI+b+"/questions/"+e+"/answers/ "+g}).then(function(a,c,d,e){f.getPostingIdQuestions(b).then(function(a){h.resolve(a)},function(a){h.reject(a)})},function(a,b,c,d){h.reject(a)}),h.promise},f}]),htsApp.controller("newPostController",["$scope","$modal","newPostFactory","Session","authModalFactory",function(a,b,c,d,e){a.userObj=d.userObj,a.newPost=function(){var d=b.open({templateUrl:"/js/newPost/modals/newPost/partials/newPost.html",controller:"newPostModal",size:"lg",keyboard:!1,backdrop:"static",resolve:{mentionsFactory:function(){return c}}});d.result.then(function(a){},function(b){"stageOneSuccess"===b.reason&&a.pushtoExternalService(b.post),console.log("Modal dismissed at: "+new Date)})},a.pushtoExternalService=function(c){var d=b.open({templateUrl:"/js/newPost/modals/pushToExternalSources/partials/newPost.pushToExternalSources.html",controller:"pushNewPostToExternalSources",resolve:{newPost:function(){return c}}});d.result.then(function(a){},function(b){"stageTwoSuccess"===b.reason&&a.congrats(b),console.log("Modal dismissed at: "+new Date)})},a.congrats=function(a){var c=b.open({templateUrl:"/js/newPost/modals/congrats/partials/newPost.congrats.html",controller:"newPostCongrats",resolve:{newPost:function(){return a}}});c.result.then(function(){},function(a){"dismiss"===a&&console.log("Modal dismissed at: "+new Date)})},a.signIn=function(a){e.signInModal()},a.signUp=function(a){e.signUpModal()}}]),htsApp.controller("newPostCongrats",["$scope","$modal","$modalInstance","newPost","myPostsFactory","Session","socketio",function(a,b,c,d,e,f,g){a.newPost=d,console.log(d),e.getAllUserPosts(f.userObj.user_settings.name).then(function(){for(var a=0;a<e.userPosts.data.length;a++){var b=e.userPosts.data[a];g.joinPostingRoom(b.postingId,"postingOwner")}}),a.dismiss=function(a){c.dismiss(a)}}]),htsApp.controller("newPostModal",["$scope","$http","$q","$modalInstance","$timeout","$modal","mentionsFactory","$templateCache","ENV","Session","authModalFactory","$window",function(a,b,c,d,e,f,g,h,j,k,l,m){a.demoCleared=!1,a.clearDemo=function(){console.log("clearing contents"),a.demoCleared||(document.getElementById("htsPost").innerHTML="",a.demoCleared=!0)},a.jsonObj=g.jsonTemplate,a.formatted_jsonObj=function(){return JSON.stringify(a.jsonObj,null,4)},a.dismiss=function(a){g.resetJsonTemplate(),d.dismiss(a)},d.opened.then(function(){console.log(a),a.dropzoneConfig={options:{paramName:"file",maxFilesize:15,maxFiles:10,thumbnailWidth:48,thumbnailHeight:48,previewTemplate:h.get("dropzone-thumbnail.html"),acceptedFiles:".jpeg,.jpg,.png,.gif",url:"/upload",autoProcessQueue:!1,uploadMultiple:!0,parallelUploads:10,clickable:"#imageUpload",previewsContainer:"#imgPreviewsContainer",dictDefaultMessage:""},eventHandlers:{sendingmultiple:function(a,b,c){console.log("sending for upload!")},successmultiple:function(b,c){console.log("what is this!",c);var d=a.jsonObj;d.images=c.images,a.publishPost()},addedfile:function(){console.log("image added"),a.numImages?(a.numImages=a.numImages+1,a.$apply(a.numImages)):(a.numImages=1,a.$apply(a.numImages))},removedfile:function(){console.log("image removed"),a.numImages=a.numImages-1,scope.$apply(a.numImages)},uploadprogress:function(a){},totaluploadprogress:function(b){a.uploadProgress=b,a.$apply(a.uploadProgress),100>b?(a.uploadMessage=b+"%",a.$apply(a.uploadProgress)):100===b&&(a.uploadMessage="Preparing photos.. please wait.",a.$apply(a.uploadProgress))}},init:{}}}),a.processPost=function(){k.userObj.user_settings.loggedIn?a.numImages?a.dropzoneConfig.init():a.publishPost():l.signInModal()},a.cleanModel=function(a,b){g.cleanModel(a,b)},a.publishPost=function(){var c=a.jsonObj;for(c.username=k.userObj.user_settings.name,c.heading="",i=0;i<c.mentions.hashtags.length;i++)i!==c.mentions.hashtags.length-1?c.heading+=c.mentions.hashtags[i].hashtag+" ":c.heading+=c.mentions.hashtags[i].hashtag,c.mentions.hashtags[i]=c.mentions.hashtags[i].hashtag;b.post(j.postingAPI,c).success(function(a){console.log("-----Post Complete----"),console.log(a),d.dismiss({reason:"stageOneSuccess",post:a})}).error(function(a,b,c,d){alert("post failed")})},a.searchProducts=function(b){console.log(b),b&&g.predictProduct(b).then(function(b){a.products=b})},a.getProductTextRaw=function(a){return g.getProductMetaData(a).then(function(a){}),'<span class="mention-highlighter" contentEditable="false">#'+a.value+"</span>"},a.map=g.googleMap,a.searchPlaces=function(b){console.log(b),b&&g.predictPlace(b).then(function(b){a.places=b,console.log("Here is scope.places",a.places)})},a.getPlacesTextRaw=function(a){return g.getPlaceMetaData(a).then(function(a){console.log(a),console.log("done")}),console.log("updated ui"),'<span class="mention-highlighter-location" contentEditable="false">@'+a.description+"</span>"},a.searchPrice=function(b){console.log(b),b&&(a.prices=g.predictPrice(b),console.log("here is scope.prices",a.prices))},a.getPricesTextRaw=function(a){return g.getPriceMetaData(a),'<span class="mention-highlighter-price" contentEditable="false">$'+a.suggestion+"</span>"},function(){e(function(){a.demoCleared||$(".mention-highlighter").triggerHandler("show"),e(function(){a.demoCleared||($(".mention-highlighter").triggerHandler("hide"),$(".mention-highlighter-price").triggerHandler("show")),e(function(){a.demoCleared||($(".mention-highlighter-price").triggerHandler("hide"),$(".mention-highlighter-location").triggerHandler("show")),e(function(){a.demoCleared||($(".mention-highlighter-location").triggerHandler("hide"),$(".sellModalButton").triggerHandler("show")),e(function(){$(".sellModalButton").triggerHandler("hide")},4e3)},4e3)},4e3)},4e3)},1e3)}()}]),htsApp.factory("newPostFactory",["$q","$http","ENV","utilsFactory","Notification",function(a,b,c,d,e){var f={};return f.jsonTemplate={annotations:[],category:null,category_name:null,category_group:null,category_group_name:null,heading:null,body:null,images:[],location:{},mentions:{hashtags:[],atTags:[],priceTag:[]},price:null,price_avg:null,price_type:null,source:"HSHTG",username:null},f.resetJsonTemplate=function(){f.jsonTemplate={annotations:[],category:null,category_name:null,category_group:null,category_group_name:null,heading:null,body:null,images:[],location:{},mentions:{hashtags:[],atTags:[],priceTag:[]},price:null,price_avg:null,price_type:null,source:"HSHTG",username:null}},f.predictProduct=function(c){var d=[],e={value:c},f=a.defer();return b.jsonp("//suggestqueries.google.com/complete/search?callback=?",{params:{client:"products-cc",hl:"en",jsonp:"JSON_CALLBACK",gs_rn:53,gs_ri:"products-cc",ds:"sh",cp:1,gs_id:9,q:c,xhr:"t"}}).success(function(a,b){a[1].length>0?(angular.forEach(a[1],function(a,b){var c=document.createElement("DIV");c.innerHTML=a[0];var e=c.textContent||c.innerText||"";d.push({value:e})}),d[0].value!==e.value&&d.splice(0,0,e),d.length>7&&(d.length=7)):(console.log("nothing found"),d.push(e)),f.resolve(d)}),f.promise},f.getProductMetaData=function(g){var h=a.defer();if(g&&this.jsonTemplate.mentions.hashtags.push(g.value),this.jsonTemplate.mentions.hashtags.length){var i=new Hashtable;i.put("year","Year"),i.put("condition","Condition"),i.put("make","Make"),i.put("title_status","Title"),i.put("model","Model"),i.put("mileage","Mileage"),i.put("transmission","Transmission"),i.put("drive","Drive"),i.put("paint_color","Paint"),i.put("type","Type"),i.put("fuel","Fuel"),i.put("size","Size"),i.put("bathrooms","Bath"),i.put("no_smoking","Smoking"),i.put("bedrooms","Rooms"),i.put("dogs","Dogs"),i.put("cats","Cats"),i.put("attached_garage","Garage"),i.put("laundry_on_site","Laundry"),i.put("sqft","Sq Ft"),i.put("size_dimensions","Dimensions"),i.put("body_type","Body Type"),i.put("drive_type","Drive Type"),i.put("engine","Engine"),i.put("exterior_color","Exterior Color"),i.put("for_sale_by","Seller Type"),i.put("interior_color","Interior Color"),i.put("fuel_type","Fuel Type"),i.put("listing_type","Listing Type"),i.put("number_of_cylinders","Cylinders"),i.put("options","Options"),i.put("power_options","Power Options"),i.put("safety_features","Safety"),i.put("ship_to_location","Ship To"),i.put("trim","Trim"),i.put("vehicle_title","Title"),i.put("vin","Vin"),i.put("warranty","Warranty"),i.put("bodyStyle","Body Type"),i.put("drivetrain","Drive Train"),i.put("exteriorColor","Exterior Color"),i.put("interiorColor","Interior Color"),i.put("Color","Color"),i.put("Brand","Brand"),i.put("Material Type","Material Type"),i.put("Model","Model"),i.put("Warranty","Warranty"),i.put("CPU Speed","Processor Speed"),i.put("CPU Type","Processor Type"),i.put("Display Size","Screen Size"),i.put("Operating System","OS Version"),i.put("Size","Storage Capacity"),i.put("System Memory Size","Memory"),i.put("Department","Department");var j=this.jsonTemplate.mentions.hashtags.join(" ");b.get(c.groupingsAPI+"popular",{params:{query:j}}).success(function(a,g){var h=a;h.length?b.get("../search/categories",{params:{categoryCode:h[0].code}}).success(function(a,g){f.jsonTemplate.category=a.metadata.code,f.jsonTemplate.category_name=a.metadata.name,f.jsonTemplate.category_group=a.metadata.group_code,f.jsonTemplate.category_group_name=a.metadata.group_name;var h=new Hashtable,k=0,l=0,m=0,n={start:0,count:500,filters:{mandatory:{contains:{heading:j}},optional:{exact:{categoryCode:[f.jsonTemplate.category,""]}}},geo:{coords:["-122.431297","37.773972"],min:0,max:1e5}},o=d.bracketNotationURL(n);b({method:"GET",url:c.postingAPI+o}).success(function(a){if(console.log("ANNOTATION Query response: ",a),a.results.length){for(var d=0;d<a.results.length;d++){var g=a.results[d];if(g.annotations){var n=g.annotations;for(var o in n)if(i.containsKey(o))if(k++,h.containsKey(o)){var p=h.get(o),q=p+1;h.put(o,q)}else h.put(o,1)}g.askingPrice&&void 0!==g.askingPrice.value&&(l++,m=parseInt(m)+parseInt(g.askingPrice.value))}if(h.size()>0){console.log("We have ",h.size(),"unique annotations in : ",k,"results");var r=[],s=Math.abs(k/h.size());console.log("Annotations should weigh more than: ",s),h.each(function(a){var b=Math.abs(h.get(a));console.log(a," has weight of",b),b>=s&&(r.push({key:i.get(a),value:null}),console.log(b,">=",s))})}m>0&&(f.jsonTemplate.price_avg=m/l),b.get(c.annotationsAPI,{params:{query:j}}).success(function(a){if(console.log("Amazon data",a),a.length){for(var b=0;b<a.length;b++){var c=a[b],d=c.name;i.containsKey(d)&&r.push({key:i.get(d),value:null})}console.log("---------------------------"),console.log("done adding Amazon annotations!"),console.log("---------------------------"),f.jsonTemplate.annotations=r}console.log(f.jsonTemplate)}).error(function(a){})}else e.success({title:"Hrmmmmm",message:"Keep your hashtags simple."})})}):e.success({title:"We need more info",message:"We could not intelligently determine what category of item you're selling.  Please add more hashtags to your description."})}).error(function(a){e.error({title:"Ooops.. Error",message:a})})}else this.jsonTemplate.annotations=[],this.jsonTemplate.category=null,this.jsonTemplate.category_name=null,this.jsonTemplate.category_group=null,this.jsonTemplate.category_group_name=null;return h.resolve(f.jsonTemplate),h.promise},f.cleanModel=function(a,b){"#"===a?(console.log("HASHTAG TO REMOVE: ",b),this.jsonTemplate.mentions.hashtags=_.without(this.jsonTemplate.mentions.hashtags,b),console.log(this.jsonTemplate),f.getProductMetaData()):"$"===a?alert("remove cost"):"@"===a&&alert("remove location")},f.googleMap=new google.maps.Map(document.createElement("map-canvas")),f.predictPlace=function(b){var c=new google.maps.LatLngBounds(new google.maps.LatLng(37.79738,-122.52464),new google.maps.LatLng(37.68879,-122.36122)),d={input:b,bounds:c,componentRestrictions:{country:"US"}},e=new google.maps.places.AutocompleteService,f=a.defer();return e.getPlacePredictions(d,function(a,b){f.resolve(a)}),f.promise},f.getPlaceMetaData=function(c){this.jsonTemplate.mentions.atTags.push(c.description);var d=new google.maps.places.PlacesService(f.googleMap),e={placeId:c.place_id},g=a.defer(),h=null,i=null,k=null,l=null;return d.getDetails(e,function(a,d){if(d!=google.maps.places.PlacesServiceStatus.OK)return void console.log(d);a.description=c.description,console.log("here is our extra meta data"),console.log(a);var e={},m={};if(m.location={},a.formatted_address&&(e.formatted_address=a.formatted_address),a.geometry.location.lat()){e.lat=a.geometry.location.lat(),e["long"]=a.geometry.location.lng();var n=a.geometry.location.lat(),o=a.geometry.location.lng();m.coords=[o,n]}if(a.address_components){for(var p=0;p<a.address_components.length;++p)"administrative_area_level_1"==a.address_components[p].types[0]&&(i=a.address_components[p].short_name,e.state=i,m.location.state=i),"locality"==a.address_components[p].types[0]&&(h=a.address_components[p].long_name,e.short_name=h,m.location.city=h),"country"==a.address_components[p].types[0]&&(k=a.address_components[p].short_name,e.country=k,m.location.country=k),"postal_code"==a.address_components[p].types[0]&&(l=a.address_components[p].short_name,e.zipcode=l,m.location.postalCode=l);m.location.postalCode||b.get("/search/reversegeocode",{params:{lat:a.geometry.location.lat(),"long":a.geometry.location.lng()}}).success(function(a,b){for(console.log(a),j=0;j<a.results[0].address_components.length;j++){var c=a.results[0].address_components[j];if("postal_code"==c.types[0]){m.location.postalCode=c.long_name;break}}})}h&&i&&(b.get("../search/locations?",{params:{level:"city",city:h+", "+i}}).success(function(a,b){a.success?(a.metadata.bounds_max_lat&&(e.bounds_max_lat=a.metadata.bounds_max_lat),a.metadata.bounds_max_long&&(e.bounds_max_long=a.metadata.bounds_max_long),a.metadata.bounds_min_lat&&(e.bounds_min_lat=a.metadata.bounds_min_lat),
a.metadata.bounds_min_long&&(e.bounds_min_long=a.metadata.bounds_min_long),a.metadata.code&&(e.city=a.metadata.code),a.metadata.full_name&&(e.long_name=a.metadata.full_name)):console.log("Could not lookup metro code with api")}),e.lat&&e["long"]?e.accuracy=0:e.formatted_address&&(f.jsonTemplate.location.accuracy=1),f.jsonTemplate.location=e,f.jsonTemplate.geo=m,g.resolve(f.jsonTemplate))}),g.promise},f.predictPrice=function(a){var b=[];return b.push({suggestion:a,rate:"flat_rate",value:a}),b.push({suggestion:a+"/hr",rate:"hourly",value:a}),b.push({suggestion:a+"/day",rate:"daily",value:a}),b.push({suggestion:a+"/week",rate:"weekly",value:a}),b.push({suggestion:a+"/month",rate:"monthly",value:a}),b.push({suggestion:a+"/year",rate:"yearly",value:a}),b},f.getPriceMetaData=function(a){this.jsonTemplate.price=a.value,this.jsonTemplate.mentions.priceTag.push(a.suggestion),this.jsonTemplate.price_type=a.rate},f}]),htsApp.controller("pushNewPostToExternalSources",["$scope","$modal","$modalInstance","$q","externalSourcesSelection","newPost","Notification","facebookFactory","ebayFactory","twitterFactory",function(a,b,c,d,e,f,g,h,i,j){a.dismiss=function(b){a.sourceSelections.length?a.publishToFacebook().then(function(){a.publishToTwitter().then(function(){a.publishToAmazon().then(function(){a.publishToEbay().then(function(){a.publishToCraigslist().then(function(){c.dismiss({reason:b,post:f})})})})})}):c.dismiss({reason:b,post:f})},a.publishToEbay=function(){var b=d.defer();return _.contains(a.sourceSelections,"eBay")?i.publishToEbay(f).then(function(a){g.success({message:"eBay publishing success!",delay:1e4}),b.resolve()},function(a){console.log("ebay err",a);try{g.error({title:"eBay "+a.name,message:a.sourceError.details[0].LongMessage[0],delay:1e4})}catch(c){g.error({title:"eBay "+a.name,message:a.message||"Please contact support",delay:1e4})}b.resolve()}):b.resolve(),b.promise},a.publishToFacebook=function(){var b=d.defer();return _.contains(a.sourceSelections,"Facebook")?h.publishToWall(f).then(function(a){g.success({message:"Facebook publishing success!",delay:1e4}),b.resolve()},function(a){g.error({title:"Facebook publishing error",message:a.error.message,delay:1e4}),b.resolve()}):b.resolve(),b.promise},a.publishToTwitter=function(){var b=d.defer();return _.contains(a.sourceSelections,"Twitter")?j.publishToTwitter(f).then(function(a){g.success({message:"Twitter publishing success!",delay:1e4}),b.resolve()},function(a){g.error({title:"Twitter publishing error",message:a.error.message,delay:1e4}),b.resolve()}):b.resolve(),b.promise},a.publishToAmazon=function(){var b=d.defer();return _.contains(a.sourceSelections,"Amazon")?(g.error({title:"Amazon publishing error",message:"push to amazon coming soon!",delay:1e4}),b.resolve()):b.resolve(),b.promise},a.publishToCraigslist=function(){var b=d.defer();return _.contains(a.sourceSelections,"Craigslist")?(g.error({title:"Craigslist publishing error",message:"push to craiglist coming soon!",delay:1e4}),b.resolve()):b.resolve(),b.promise},a.sources=e.sources,a.sourceSelections=[],a.$watch("sources.marketplaces|filter:{selected:true}",function(b){a.sourceSelections=b.map(function(a){return a.name})},!0)}]),htsApp.factory("externalSourcesSelection",["$http",function(a){var b={};return b.sources={marketplaces:[{name:"eBay","class":"ebay",selected:!1},{name:"Amazon","class":"amazon",selected:!1},{name:"Craigslist","class":"craigslist",selected:!1},{name:"Facebook","class":"facebook",selected:!1},{name:"Twitter","class":"twitter",selected:!1}]},b}]),htsApp.controller("notifications.controller",["$scope",function(a){function b(a){for(var b=[],c=0;a>c;c++)b.push({text:c,size:~~(100*Math.random()+50)});return b}a.items={collection:b(1e3)}}]),htsApp.controller("profile.controller",["$scope","profileFactory",function(a,b){a.nav=b.nav}]),htsApp.factory("profileFactory",["$http","$location","$q","ENV",function(a,b,c,d){var e={};return e.messages={"private":{sent:[],received:[]}},e.nav=[{title:"Messages",link:"profile.messages",data:e.messages},{title:"Reviews",link:"profile.reviews",data:[]}],e.getUserProfile=function(d){var e=c.defer(),f=b.protocol()+"://"+b.host()+":"+b.port()+"/getprofile?username="+d;return a({method:"GET",url:f}).then(function(a,b,c,d){e.resolve(a)},function(a,b,c,d){e.reject(a)}),e.promise},e}]),htsApp.controller("results.controller",["$scope","$state","searchFactory","splashFactory","uiGmapGoogleMapApi","uiGmapIsReady",function(a,b,c,d,e,f){a.status=c.status,a.views=c.views,a.openSplash=function(a){d.result=a.result,b.go("results.splash",{id:a.result.postingId})};var g=function(b){c.paginate(b).then(function(d){200!==d.status?(c.status.pleaseWait=!1,c.status.loading=!1,c.status.error.message=":( Oops.. Something went wrong.",c.status.error.trace=d.data.error):200===d.status&&(d.data.results.length?(a.results?c.filterArray(a.views,"pagination"):(c.filterArray(a.views,"pagination"),a.infiniteScroll=function(d,e){console.log("startIndex: "+d,"endIndex: "+e,"numRows: "+a.results.gridRows.length),!c.status.loading&&e>=a.results.gridRows.length-3&&(console.log("paginating"),c.status.loadingMessage="Fetching more awesome...",c.status.loading=!0,b+=1,g(b))}),a.results=c.results,c.status.pleaseWait=!1,c.status.loading=!1):d.data.results.length||0!==b?!d.data.results.length&&b>0&&(c.status.pleaseWait=!1,c.status.loadingMessage="Congratulations!  You've finished the internet!"):(c.status.pleaseWait=!1,c.status.loading=!1,c.status.error.message="¯\\_(ツ)_/¯  Nothing found.  Keep your searches simple."))},function(a){c.status.pleaseWait=!1,c.status.loading=!1,c.status.error.message="(゜_゜) Oops.. Something went wrong.",c.status.error.trace=a.data.error})};g(0),e.then(function(b){a.map=c.map})}]),htsApp.directive("onVsIndexChange",["$parse",function(a){return function(b,c,d){var e=a(d.onVsIndexChange),f=function(){e(b)};b.$watch("startIndex",f),b.$watch("endIndex",f)}}]),htsApp.directive("resizeGrid",["$rootScope","$window","searchFactory",function(a,b,c){return{restrict:"A",link:function(a,d){c.getInnerContainerDimensions=function(){return{w:d.width(),h:d.height()}},angular.element(b).bind("resize",function(){a.views.gridView&&c.filterArray(a.views,"resize"),a.$apply()})}}}]),htsApp.factory("searchFactory",["$http","$stateParams","$location","$q","$log","$timeout","utilsFactory","ENV",function(a,b,c,d,e,f,g,h){var j={};j.results={gridRows:[],unfiltered:[]},j.filter={mustHaveImage:!1,mustHavePrice:!1},j.sort={distance:!0,price:!1,datePosted:!1},j.priceSlider={min:0,max:0,step:1,rangeValue:[0,0],userSetValue:!1},j.views={gridView:!0,showMap:!1},j.status={pleaseWait:!0,error:{}},j.getInnerContainerDimensions=function(){return"function re-defined via resizeGrid directive"},j.paginate=function(a){var c=d.defer();return 0===a?j.getPopularCategories().then(function(a){if(200===a.status&&a.data.length){for(var b=[],c=0,d=0;d<a.data.length;d++){var e=a.data[d];c+=e.count}for(var f=c/a.data.length,g=0;g<a.data.length;g++){var h=a.data[g];h.count>=f&&b.push(h.code)}b.length&&(j.defaultParams.filters.optional={exact:{categoryCode:b.join(",")}})}}).then(function(){if(console.log(b),j.defaultParams.filters.mandatory.contains.heading=b.q,b.locationObj&&b.locationObj.geometry){j.defaultParams.geo.lookup=!1;var d=b.locationObj.geometry.location.lat(),e=b.locationObj.geometry.location.lng();j.defaultParams.geo.coords=[e,d]}j.query(a).then(function(a){c.resolve(a)})}):j.query(a).then(function(a){c.resolve(a)}),c.promise},j.getPopularCategories=function(){var c=d.defer();return a({method:"GET",url:h.groupingsAPI+"popular",params:{query:b.q}}).then(function(a){c.resolve(a)},function(a){c.reject(a)}),c.promise},j.query=function(b){var c=d.defer(),e=g.bracketNotationURL(j.defaultParams);return console.log("final URL",e),a({method:"GET",url:h.postingAPI+e}).then(function(a){a.data.results.length&&(j.defaultParams={start:(b+1)*a.data.options.count,count:a.data.options.count,filters:a.data.options.filters,geo:{coords:a.data.options.geo.coords,min:a.data.options.geo.min,max:a.data.options.geo.max},sort:{}},j.results.unfiltered=j.results.unfiltered.concat(a.data.results)),c.resolve(a)},function(a){c.reject(a)}),c.promise},j.defaultParams={start:0,count:35,filters:{mandatory:{contains:{heading:null}}},geo:{lookup:!0,min:0,max:1289e4}},j.map={bounds:{},center:{latitude:0,longitude:0},zoom:8,markers:[],options:{zoomControlOptions:{style:google.maps.ZoomControlStyle.SMALL,position:google.maps.ControlPosition.RIGHT_TOP},panControl:!1,mapTypeControl:!1,maxZoom:22,minZoom:0,streetViewControlOptions:{position:google.maps.ControlPosition.TOP_RIGHT}},clusterOptions:{gridSize:35,maxZoom:22,minZoom:0,zoomOnClick:!0,averageCenter:!0,minimumClusterSize:1,styles:[{textColor:"white",fontFamily:"Open Sans, Helvetica, Arial, sans-serif",url:"https://static.hashtagsell.com/htsApp/map-elements/cluster1.png",height:35,width:35},{textColor:"white",fontFamily:"Open Sans, Helvetica, Arial, sans-serif",url:"https://static.hashtagsell.com/htsApp/map-elements/cluster2.png",height:35,width:35},{textColor:"white",fontFamily:"Open Sans, Helvetica, Arial, sans-serif",url:"https://static.hashtagsell.com/htsApp/map-elements/cluster2.png",height:35,width:35}]},refresh:!1},j.cachedColumnCalculation=null,j.generateRows=function(a,b,c){var d;if(c.gridView){var e=j.getInnerContainerDimensions(),f=290;d=Math.floor(e.w/f),j.results.gridPercentageWidth=100/d}else d=1;if(d!==j.cachedColumnCalculation||"filter"===b||"pagination"===b){j.cachedColumnCalculation=d,j.results.gridRows=[];for(var g=0;g<a.length;g++){var h;if(h=c.gridView?390:0===a[g].images.length?179:1===a[g].images.length?261:420,g%d===0){for(var i={rowHeight:h,rowContents:[]},k=0;d>k;k++)g+k<a.length&&(a[g+k].askingPrice.value&&j.updatePriceSlider(a[g+k].askingPrice.value),i.rowContents.push(a[g+k]));j.results.gridRows.push(i),g=g+k-1}}var l=j.priceSlider.max;100>l?j.priceSlider.step=1:l>100&&500>l?j.priceSlider.step=5:l>500&&2e3>l?j.priceSlider.step=10:l>2e3&&1e4>l?j.priceSlider.step=50:l>1e4&&(j.priceSlider.step=50),console.log("Grid Rows: ",j.results.gridRows)}},j.updatePriceSlider=function(a){parseInt(a)>parseInt(j.priceSlider.max)&&(j.priceSlider.max=a,j.priceSlider.userSetValue||(j.priceSlider.rangeValue[1]=a))},j.markerMaker=function(a,b,c){var d={id:a.postingId,coords:{latitude:a.geo.coordinates[1],longitude:a.geo.coordinates[0]},title:a.heading,options:{visible:c}};j.views.showMap&&(j.map.markers[b]?j.map.markers[b].options.visible=c:j.map.markers[b]=d)},j.mustHaveImage=function(a,b){var c=Boolean(a.images.length);return j.markerMaker(a,b,c),c},j.mustHavePrice=function(a,b){var c=Boolean(a.askingPrice.value);return j.markerMaker(a,b,c),c},j.mustFitPriceRange=function(a,b){var c=Boolean(!a.askingPrice.value||a.askingPrice.value>=j.priceSlider.rangeValue[0]&&a.askingPrice.value<=j.priceSlider.rangeValue[1]);return j.markerMaker(a,b,c),c},j.mustHaveImageAndPrice=function(a,b){var c=Boolean(a.images.length&&a.askingPrice.value);return j.markerMaker(a,b,c),c},j.mustHaveImageAndMustFitPriceRange=function(a,b){var c=Boolean(a.images.length&&a.askingPrice.value>=j.priceSlider.rangeValue[0]&&a.askingPrice.value<=j.priceSlider.rangeValue[1]);return j.markerMaker(a,b,c),c},j.mustHavePriceAndMustFitPriceRange=function(a,b){var c=Boolean(a.askingPrice.value&&a.askingPrice.value>=j.priceSlider.rangeValue[0]&&a.askingPrice.value<=j.priceSlider.rangeValue[1]);return j.markerMaker(a,b,c),c},j.mustHavePriceAndMustHaveImageAndMustFitPriceRange=function(a,b){var c=Boolean(a.images.length&&a.askingPrice.value&&a.askingPrice.value>=j.priceSlider.rangeValue[0]&&a.askingPrice.value<=j.priceSlider.rangeValue[1]);return j.markerMaker(a,b,c),c},j.filterArray=function(a,b){var c,d=j.filter,e=j.priceSlider;if(d.mustHavePrice&&d.mustHaveImage&&e.userSetValue)c=j.results.unfiltered.filter(j.mustHavePriceAndMustHaveImageAndMustFitPriceRange),j.generateRows(c,b,a);else if(d.mustHaveImage&&e.userSetValue)c=j.results.unfiltered.filter(j.mustHaveImageAndMustFitPriceRange),j.generateRows(c,b,a);else if(d.mustHavePrice&&e.userSetValue)c=j.results.unfiltered.filter(j.mustHavePriceAndMustFitPriceRange),j.generateRows(c,b,a);else if(d.mustHaveImage&&d.mustHavePrice)c=j.results.unfiltered.filter(j.mustHaveImageAndPrice),j.generateRows(c,b,a);else if(d.mustHaveImage)c=j.results.unfiltered.filter(j.mustHaveImage),j.generateRows(c,b,a);else if(d.mustHavePrice)c=j.results.unfiltered.filter(j.mustHavePrice),j.generateRows(c,b,a);else if(e.userSetValue)c=j.results.unfiltered.filter(j.mustFitPriceRange),j.generateRows(c,b,a);else{for(i=0;i<j.results.unfiltered.length;i++)j.markerMaker(j.results.unfiltered[i],i,!0);j.generateRows(j.results.unfiltered,b,a)}j.views.showMap&&k()};var k=function(){j.map.refresh=!0,f(function(){j.map.refresh=!1},100)};return j.resetResultsView=function(){j.results.gridRows=[],j.results.unfiltered=[],j.priceSlider.min=0,j.priceSlider.max=0,j.priceSlider.step=1,j.priceSlider.rangeValue=[0,0],j.priceSlider.userSetValue=!1,j.filter.mustHaveImage=!1,j.filter.mustHavePrice=!1,j.views.gridView=!0,j.views.showMap=!1,j.map.markers=[],j.status.pleaseWait=!0,j.status.error={},j.defaultParams={start:0,count:35,filters:{mandatory:{contains:{heading:null}}},geo:{lookup:!0,min:0,max:1e5}}},j}]),htsApp.service("Session",["$window","$http","$q","$state",function(a,b,c,d){return this.defaultUserObj={loggedIn:!1,profile_photo:"//static.hashtagsell.com/htsApp/placeholders/user-placeholder.png",banner_photo:"//static.hashtagsell.com/htsApp/placeholders/header-placeholder.png",safe_search:!0,email_provider:[{name:"Always Ask",value:"ask"}],favorites:[],feed_categories:[{name:"Real Estate",code:"RRRR"},{name:"For Sale",code:"SSSS"},{name:"Vehicles",code:"VVVV"}]},this.userObj={user_settings:JSON.parse(a.localStorage.getItem("hts_storage"))||this.defaultUserObj},this.updateServer=function(a){console.log("updating server");var d=c.defer();return b.post("/updateUserSettings",{userSettings:this.userObj.user_settings}).then(function(b){b.data.success?(d.resolve(),a&&a(b)):console.log(b)},function(a,b,c,e){d.reject()}),d.promise},this.create=function(b){console.log("Updating local storage with",b),b.user_settings.loggedIn=!0,this.userObj.user_settings=b.user_settings,console.log("data about to be written to local storage",this.userObj),a.localStorage.hts_storage=angular.toJson(this.userObj.user_settings)},this.destroy=function(){console.log("clearing user obj"),this.userObj.user_settings=this.defaultUserObj,console.log("Destroying HTML5 Session"),a.localStorage.removeItem("hts_storage"),d.go("feed")},this.getSessionValue=function(a){return this.userObj.user_settings[a]?this.userObj.user_settings[a]:this.userObj.user_settings.linkedAccounts[a]?this.userObj.user_settings.linkedAccounts[a]:!1},this.setSessionValue=function(a,b,c){console.log("set "+a+" in HTML5 user settings to ",b),this.userObj.user_settings[a]?this.userObj.user_settings[a]=b:this.userObj.user_settings.linkedAccounts[a]&&(this.userObj.user_settings.linkedAccounts[a]=b),this.create(this.userObj),this.updateServer(c)},this.getUserFromServer=function(){var a=c.defer();return b.get("/getUserSettings").then(function(b){var c={};c.user_settings=b.data,a.resolve(c)},function(b,c,d,e){a.reject()}),a.promise},this}]),htsApp.controller("settings.account.controller",["$scope","$timeout","$window","Session","ebayFactory","facebookFactory","twitterFactory","Notification",function(a,b,c,d,e,f,g,h){a.userObj=d.userObj,a.options={safeSearch:["On","Off"],defaultEmail:[{name:"Always Ask",value:"ask"},{name:"Gmail",value:"gmail"},{name:"Yahoo",value:"yahoo"},{name:"Hotmail",value:"hotmail"},{name:"AOL",value:"aol"},{name:"Use Default Mail Client",value:"mailto"}],location:["Approximate","Exact"]},a.defaultEmail=d.userObj.user_settings.email_provider[0].value,a.getSafeSearch=function(){return d.userObj.user_settings.safe_search?a.options.safeSearch[0]:a.options.safeSearch[1]},a.safeSearch=a.getSafeSearch(),a.setSafeSearch=function(c){"On"===c?d.setSessionValue("safe_search",!0,function(){a.safeSearchUpdated=!0,b(function(){a.safeSearchUpdated=!1},3e3)}):"Off"===c&&d.setSessionValue("safe_search",!1,function(){a.safeSearchUpdated=!0,b(function(){a.safeSearchUpdated=!1},3e3)})};var i=function(a){switch(a){case"ask":return[{name:"Always Ask",value:"ask"}];case"gmail":return[{name:"Gmail",value:"gmail"}];case"yahoo":return[{name:"Yahoo",value:"yahoo"}];case"hotmail":return[{name:"Hotmail",value:"hotmail"}];case"aol":return[{name:"AOL",value:"aol"}];case"mailto":return[{name:"Use Default Mail Client",value:"mailto"}]}};a.setDefaultEmail=function(c){c=i(c),d.setSessionValue("email_provider",c,function(){a.defaultEmailUpdated=!0,b(function(){a.defaultEmailUpdated=!1},3e3)})},a.getLocation=function(){switch(d.userObj.user_settings.location_type){case"Approximate":return a.options.location[0];case"Exact":return a.options.location[1]}},a.location=a.getLocation(),a.setLocation=function(c){d.setSessionValue("location_type",c,function(){a.locationUpdated=!0,b(function(){a.locationUpdated=!1},3e3)})},a.getEbaySessionID=function(){a.ebay={},e.getEbaySessionID().then(function(a){d.setSessionValue("ebay",a.data.ebay,function(){h.success({message:"Successfully linked to eBay!",delay:1e4})})},function(b){a.ebay.sessionId=b.data.sessionId,a.ebay.err=b.data.ebay.Errors.LongMessage,h.error({title:"Manually link eBay account",message:"After completing eBay authorization please click the big red button below.",delay:1e4})})},a.getEbayToken=function(){e.manuallyGetEbayToken(a.ebay.sessionId).then(function(b){console.log(b),b.data.success?d.setSessionValue("ebay",b.data.ebay,function(){console.log("ebay account connected!")}):(a.ebay.sessionId=!1,a.ebay.err=b.data.ebay.Errors.LongMessage)})},a.disconnectFacebook=function(){f.disconnectFacebook()},a.disconnectTwitter=function(){g.disconnectTwitter()},a.disconnectEbay=function(){e.disconnectEbay()},a.disconnectAmazon=function(){d.setSessionValue("amazon",{},function(){console.log("amazon account disconnected!")})}}]),htsApp.controller("settings.password.controller",["$scope","authFactory",function(a,b){a.updatePassword=function(c){if(c){var d=a.currentPassword,e=a.newPassword;b.updatePassword(d,e).then(function(b){b.error?a.message=b.error:b.success&&alert("done!")},function(){alert("update password error")})}}}]),htsApp.controller("settings.payment.controller",["$scope",function(a){}]),htsApp.controller("settings.profile.controller",["$scope","Session","$templateCache",function(a,b,c){a.userObj=b.userObj,a.bindingObj={currentlyUploadingProfilePhoto:!1,currentlyUploadingBannerPhoto:!1,requireUpdate:!0},a.profileDropzoneConfig={options:{paramName:"profilePhoto",maxFilesize:10,acceptedFiles:".jpeg,.jpg,.png,.gif",url:"/upload",autoProcessQueue:!0,uploadMultiple:!1,addRemoveLinks:!1,thumbnailWidth:90,thumbnailHeight:90,previewsContainer:"#profilePreview",previewTemplate:c.get("profileUploadTemplate.tpl"),clickable:".triggerProfileImageUpload",dictDefaultMessage:""},eventHandlers:{addedfile:function(){a.$apply(function(){a.bindingObj.currentlyUploadingProfilePhoto=!0})},success:function(c){var d=JSON.parse(c.xhr.response);console.log(d),b.setSessionValue("profile_photo",d.url,a.$apply(function(){a.bindingObj.currentlyUploadingProfilePhoto=!1}))},complete:function(){console.log("complete")}}},a.bannerDropzoneConfig={options:{paramName:"bannerPhoto",maxFilesize:10,acceptedFiles:".jpeg,.jpg,.png,.gif",url:"/upload",autoProcessQueue:!0,uploadMultiple:!1,addRemoveLinks:!1,thumbnailWidth:180,thumbnailHeight:120,previewsContainer:"#bannerPreview",previewTemplate:c.get("bannerUploadTemplate.tpl"),clickable:".triggerBannerImageUpload",dictDefaultMessage:""},eventHandlers:{addedfile:function(){a.$apply(function(){a.bindingObj.currentlyUploadingBannerPhoto=!0})},success:function(c){var d=JSON.parse(c.xhr.response);console.log(d),b.setSessionValue("banner_photo",d.url,a.$apply(function(){a.bindingObj.currentlyUploadingBannerPhoto=!1}))},complete:function(){console.log("complete")}}},a.requireUpdate=function(){a.bindingObj.requireUpdate=!1},a.submitUpdatedProfile=function(){b.setSessionValue("biography",a.userObj.user_settings.biography,function(){a.bindingObj.requireUpdate=!0})}}]),htsApp.controller("sideNav.controller",["$scope","$rootScope","sideNavFactory","splashFactory",function(a,b,c,d){a.sideNav=c,a.result=d.result,b.$on("$stateChangeSuccess",function(a,b,d,e,f){c.updateSideNav(b),c.settingsMenu[0].link=e.name}),b.$on("$stateChangeStart",function(a,b,d,e,f){c.redirect=b})}]),htsApp.factory("sideNavFactory",["Session",function(a){var b={};return b.defaultMenu=[{name:"Feed",alerts:null,link:"feed",active:!1},{name:"My Posts",alerts:null,link:"myposts",active:!1},{name:"Watch List",alerts:null,link:"watchlist",active:!1},{name:"Notify Me",alerts:null,link:"notifications",active:!1}],b.items=b.defaultMenu,b.settingsMenu=[{name:"Back",alerts:null,link:null,active:!1},{name:"Account",alerts:null,link:"settings.account",active:!1},{name:"Password",alerts:null,link:"settings.password",active:!1},{name:"Profile",alerts:null,link:"settings.profile",active:!1},{name:"Payment & Shipping",alerts:null,link:"settings.payment",active:!1}],b.updateSideNav=function(a){switch(a.name){case"settings":b.settingsMenu[0].active=!1,b.settingsMenu[1].active=!1,b.settingsMenu[2].active=!1,b.settingsMenu[3].active=!1,b.settingsMenu[4].active=!1,b.items=b.settingsMenu;break;case"settings.account":b.settingsMenu[0].active=!1,b.settingsMenu[1].active=!0,b.settingsMenu[2].active=!1,b.settingsMenu[3].active=!1,b.settingsMenu[4].active=!1,b.items=b.settingsMenu;break;case"settings.password":b.settingsMenu[0].active=!1,b.settingsMenu[1].active=!1,b.settingsMenu[2].active=!0,b.settingsMenu[3].active=!1,b.settingsMenu[4].active=!1,b.items=b.settingsMenu;break;case"settings.profile":b.settingsMenu[0].active=!1,b.settingsMenu[1].active=!1,b.settingsMenu[2].active=!1,b.settingsMenu[3].active=!0,b.settingsMenu[4].active=!1,b.items=b.settingsMenu;break;case"settings.payment":b.settingsMenu[0].active=!1,b.settingsMenu[1].active=!1,b.settingsMenu[2].active=!1,b.settingsMenu[3].active=!1,b.settingsMenu[4].active=!0,b.items=b.settingsMenu;break;case"feed":b.defaultMenu[0].active=!0,b.defaultMenu[1].active=!1,b.defaultMenu[2].active=!1,b.defaultMenu[3].active=!1,b.items=b.defaultMenu;break;case"myposts":b.defaultMenu[0].active=!1,b.defaultMenu[1].active=!0,b.defaultMenu[2].active=!1,b.defaultMenu[3].active=!1,b.items=b.defaultMenu;break;case"watchlist":b.defaultMenu[0].active=!1,b.defaultMenu[1].active=!1,b.defaultMenu[2].active=!0,b.defaultMenu[3].active=!1,b.items=b.defaultMenu;break;case"notifications":b.defaultMenu[0].active=!1,b.defaultMenu[1].active=!1,b.defaultMenu[2].active=!1,b.defaultMenu[3].active=!0,b.items=b.defaultMenu;break;case"results":b.defaultMenu[0].active=!1,b.defaultMenu[1].active=!1,b.defaultMenu[2].active=!1,b.defaultMenu[3].active=!1,b.items=b.defaultMenu;break;case"profile":b.defaultMenu[0].active=!1,b.defaultMenu[1].active=!1,b.defaultMenu[2].active=!1,b.defaultMenu[3].active=!1,b.items=b.defaultMenu}},b.sideNav={hidden:!0,listView:!0},b}]),htsApp.controller("sideProfile",["$scope","Session","$templateCache",function(a,b,c){a.userObj=b.userObj,a.checkDefaultBanner=function(){return"/images/userMenu/header-placeholder.png"===a.userObj.user_settings.banner_photo},a.checkDefaultProfilePhoto=function(){return"/images/userMenu/user-placeholder.png"===a.userObj.user_settings.profile_photo},a.profileDropzoneConfig={options:{paramName:"profilePhoto",maxFilesize:10,acceptedFiles:".jpeg,.jpg,.png,.gif",url:"/upload",autoProcessQueue:!0,uploadMultiple:!1,previewTemplate:'<div style="display:none"></div>',clickable:".sideNavTriggerProfileImageUpload",dictDefaultMessage:""},eventHandlers:{success:function(a){var c=JSON.parse(a.xhr.response);console.log(c),b.setSessionValue("profile_photo",c.url,function(){console.log("done sidenav profile photo upload")})},complete:function(){console.log("complete")}}},a.bannerDropzoneConfig={options:{paramName:"bannerPhoto",maxFilesize:10,acceptedFiles:".jpeg,.jpg,.png,.gif",url:"/upload",autoProcessQueue:!0,uploadMultiple:!1,previewTemplate:'<div style="display:none"></div>',clickable:".sideNavTriggerBannerImageUpload",dictDefaultMessage:""},eventHandlers:{success:function(c){var d=JSON.parse(c.xhr.response);console.log(d),b.setSessionValue("banner_photo",d.url,a.$apply(function(){console.log("done sidenav banner photo upload")}))},complete:function(){console.log("complete")}}}}]),htsApp.factory("socketio",["ENV","$http","myPostsFactory","Notification","favesFactory",function(a,b,c,d,e){var f={postingSocket:io(a.realtimePostingAPI),userSocket:io(a.realtimeUserAPI),postings:[],usersViewing:[]};return f.joinPostingRoom=function(a,b,c){var d=0;"toggleSplash"===b?d=1:"inWatchList"===b?d=2:"postingOwner"===b&&(d=3);var e=!1;if(f.postings.length)for(var g=0;g<f.postings.length;g++){var h=f.postings[g];if(h.postingId===a){if(h.permissionLevel<d){f.postings.splice(g,1),e=!0,b=f.cachedUsername+" is joining posting room: "+a+" because requested permission level "+d+" is greater than "+h.permissionLevel;break}}else g===f.postings.length-1&&(e=!0,b=f.cachedUsername+" is joining posting room: "+a+" for first time with permission level "+d)}else e=!0,b=f.cachedUsername+" is joining posting room: "+a+" with permission level "+d+" as their first room ";e?(f.postings.push({postingId:a,permissionLevel:d}),f.postingSocket.emit("join-room",{username:f.cachedUsername,roomId:a})):b=f.cachedUsername+" already joined posting room: "+a+" with higher permission level than "+d,c&&c()},f.joinUserRoom=function(a,b,c){f.usersViewing.push(b),console.log(b+" is joining "+a+"'s room: "),f.userSocket.emit("join-room",{username:b,roomId:a}),c&&c()},f.closeAllConnections=function(a){f.leaveUserRoom(f.cachedUsername),f.cachedUsername=null,a&&a()},f.leavePostingRoom=function(a,b,c){var d=0;"toggleSplash"===b?d=1:"inWatchList"===b?d=2:"postingOwner"===b&&(d=3);var e=!1;if(f.postings.length)for(var g=0;g<f.postings.length;g++){var h=f.postings[g];if(h.postingId===a){if(h.permissionLevel<=d){f.postings.splice(g,1),e=!0,b=f.cachedUsername+" is leaving posting room: "+a+" because requested permission level "+d+" is greater than or equal to "+h.permissionLevel;break}b=f.cachedUsername+" is NOT leaving posting room: "+a+" because requested permission level "+d+" is less than "+h.permissionLevel}else g===f.postings.length-1&&(b=f.cachedUsername+" is requesting to leave posting room: "+a+" which they have not joined?")}else b=f.cachedUsername+" is requesting to leave posting room: "+a+" when they havent joined any rooms?";e&&f.postingSocket.emit("leave-room",a),c&&c()},f.leaveUserRoom=function(a,b){f.usersViewing.splice(f.usersViewing.indexOf(a),1),console.log("leaving user room: "+a),f.userSocket.emit("leave-room",a),b&&b()},f.sendMessage=function(a,b){f.userSocket.emit("private-message",{message:b,recipient:a,username:f.cachedUsername})},f.userSocket.on("private-message",function(a){console.log("emitted private message",a),d.success({title:"New message from @"+a.username,message:a.message,delay:1e4})}),f.postingSocket.on("make-offer",function(a){console.log("emitted make-offer",a),a.username===f.cachedUsername?e.checkFave(a.posting,function(b){b?e.updateFavorite(a,function(){var b='"/watchlist/offers/'+a.posting.postingId+'"';d.success({title:"<a href="+b+">Meeting Request Sent!</a>",message:"<a href="+b+">This watchlist item has been updated. You'll be notified when the seller responds.</a>",delay:1e4})}):e.addFave(a.posting,function(){var b='"/watchlist/offers/'+a.posting.postingId+'"';d.success({title:"<a href="+b+">Meeting Request Sent!</a>",message:"<a href="+b+">This item has been added to your watchlist. You'll be notified when the seller responds.</a>",delay:1e4})})}):a.posting.username===f.cachedUsername?c.getAllUserPosts(f.cachedUsername).then(function(b){var c='"/myposts/offers/'+a.posting.postingId+'"';d.success({title:"<a href="+c+">New Offer</a>",message:"<a href="+c+">@"+a.username+" would like to meet!</a>",delay:1e4})}):e.updateFavorite(a,function(){var b='"//wishlist/offers/'+a.posting.postingId+'"';d.success({title:"<a href="+b+">Another user placed an offer on an item you're watching.</a>",message:"<a href="+b+">"+a.posting.heading+" may go fast!  We're just letting you know!</a>",delay:1e4})}),console.log('%s would like to meet %s regarding postingId: "%s"',a.username,a.proposedTimes,a.posting.postingId)}),f.postingSocket.on("question",function(a){console.log("emitted question",a),a.username===f.cachedUsername?e.checkFave(a.posting,function(b){b?e.updateFavorite(a,function(){var b='"/watchlist/questions/'+a.posting.postingId+'"';d.success({title:"<a href="+b+">Question Sent!</a>",message:"<a href="+b+">This watchlist item has been updated. You'll be notified when the seller responds.</a>",delay:1e4})}):e.addFave(a.posting,function(){var b='"/watchlist/questions/'+a.posting.postingId+'"';d.success({title:"<a href="+b+">Question Sent!</a>",message:"<a href="+b+">This item has been added to your watchlist. You'll be notified when the seller responds.</a>",delay:1e4})})}):a.posting.username===f.cachedUsername?c.getAllUserPosts(f.cachedUsername).then(function(b){var c='"/myposts/questions/'+a.question.postingId+'"';d.success({title:"<a href="+c+">New Question</a>",message:"<a href="+c+">"+a.question.value+"</a>",delay:1e4})}):e.updateFavorite(a,function(){console.log("silently updated watchlist")}),console.log('%s asked a question on postingId %s : "%s"',a.question.username,a.posting.postingId,a.question.value)}),f.postingSocket.on("answer",function(a){console.log("emitted answer",a),a.posting.username!==f.cachedUsername&&e.updateFavorite(a,function(){var b='"/watchlist/questions/'+a.posting.postingId+'"';d.success({title:"<a href="+b+">Question has been answered</a>",message:"<a href="+b+">"+a.answer.value+"</a>",delay:1e4})}),console.log('%s answered a question on postingId %s : "%s"',a.posting.username,a.posting.postingId,a.answer.value)}),f.postingSocket.on("accept-offer",function(a){if(console.log("emitted offer acceptance",a),a.username===f.cachedUsername){var b='"/watchlist/offers/'+a.posting.postingId+'"';d.success({title:"<a href="+b+">@"+a.posting.username+" accepted your meeting.</a>",message:"<a href="+b+">Please meet at "+a.acceptedTime.where+" on "+a.acceptedTime.when+".  A reminder email will be sent containing the online payment URL.  Sincerely, HashtagSell Team.</a>",delay:1e4})}console.log('%s accepted offer on postingId %s : "%s"',a.posting.username,a.posting.postingId,a.acceptedTime.when)}),f.userSocket.on("reconnect",f.init),f.postingSocket.on("reconnect",f.init),f.init=function(a){if(a){f.cachedUsername=a;var b=a,c=a;f.joinUserRoom(b,c)}},f}]),htsApp.controller("splashController",["$scope","$rootScope","$sce","$state","$modal","splashFactory","Session","socketio",function(a,b,c,d,e,f,g,h){var i=["$scope","sideNavFactory","uiGmapGoogleMapApi","authModalFactory","favesFactory","qaFactory","transactionFactory",function(a,b,c,d,e,i,j){a.userObj=g.userObj,a.result=f.result,a.toggles={showCarousel:!0},c.then(function(b){a.map={settings:{center:{latitude:a.result.geo.coordinates[1],longitude:a.result.geo.coordinates[0]},options:{zoomControl:!1,panControl:!1,mapTypeControl:!1},zoom:14},marker:{id:0,coords:{latitude:a.result.geo.coordinates[1],longitude:a.result.geo.coordinates[0]}}}}),a.windowOptions={content:"please wait",disableAutoPan:!1},a.infoWindow={show:!1},a.onClick=function(){a.$apply(function(){a.infoWindow.show=!a.infoWindow.show})},a.closeClick=function(){a.infoWindow.show=!1},a.userObj.user_settings.loggedIn&&e.checkFave(a.result,function(b){a.favorited=b}),a.toggleFave=function(b){a.userObj.user_settings.loggedIn?a.favorited?e.removeFave(b,function(){a.favorited=!1,h.leavePostingRoom(b.postingId,"inWatchList")}):e.addFave(b,function(){a.favorited=!0,h.joinPostingRoom(b.postingId,"inWatchList")}):d.signInModal()},a.result.external.threeTaps.location.formatted?a.windowOptions.content=a.result.external.threeTaps.location.formatted:!function(){
var b=new google.maps.Geocoder,c=new google.maps.LatLng(a.result.geo.coordinates[0],a.result.geo.coordinates[1]);b.geocode({latLng:c},function(b,c){c===google.maps.GeocoderStatus.OK?b[1]&&(a.windowOptions.content=b[1].formatted_address):a.windowOptions.content="no address discovered"})}(),a.result.annotations&&(a.result.sanitized_annotations=f.sanitizeAnnotations(a.result.annotations)),a.sideNav=b.sideNav,a.toggleOffCanvasSideNav=function(){a.sideNav.hidden=!a.sideNav.hidden},a.questions=i.questions,a.getPostingIdQuestions=function(){i.getPostingIdQuestions(a.result.postingId).then(function(a){},function(a){console.log(a)})},a.submitQuestion=function(b){var c=a.userObj.user_settings.loggedIn;if(c){var e=a.result,f=a.userObj.user_settings.name;h.joinPostingRoom(e.postingId,"inWatchList",function(){i.submitQuestion(b,e,f).then(function(a){console.log(a)},function(a){console.log(a)})})}else d.signInModal()},a.emailSeller=function(a){j.quickCompose(a)},a.displayPhone=function(a){j.displayPhone(a)},a.placeOffer=function(a){j.placeOffer(a)},a.buyOnline=function(a){alert("online payment and shipping coming soon!")},a.placeBid=function(a){j.placeBid(a)},a.showOriginal=function(a){j.showOriginal(a)}}],j=function(){var b=e.open({backdrop:!1,templateUrl:"/js/splash/partials/splash_content.html",windowTemplateUrl:"js/splash/partials/splash_window.html",controller:i});b.result.then(function(a){},function(a){a||d.go("^")}),a.$on("$stateChangeStart",function(a,c,d,e,f){b.dismiss("direct")})};if(f.result)j();else{var k=d.params.id;f.lookupItemDetails(k).then(function(a){f.result=a.data,j()},function(a){console.log(a)})}}]),htsApp.directive("splashSideProfile",["splashFactory",function(a){return{restrict:"E",scope:{result:"="},link:function(b,c,d){if("HSHTG"===b.result.external.source.code){var e=b.result.username;a.getUserProfile(e).then(function(a){if(200!==a.status){var b=a.data.error;console.log(b)}else if(200===a.status){var d=a.data.user,e=angular.element(c[0].querySelector(".profile"));e.css({"background-image":"url("+d.banner_photo+")","background-size":"cover"});var f=angular.element(c[0].querySelector(".bs-profile-image"));f.css({"background-image":"url("+d.profile_photo+")","background-size":"cover"});var g=angular.element(c[0].querySelector(".splash-bs-username"));g.html("@"+d.name)}},function(a){console.log(a)})}else{var f=angular.element(c[0].querySelector(".profile"));if(b.result.images.length){var g=b.result.images.length-1,h=b.result.images[g].thumb||b.result.images[g].images||b.result.images[g].full;f.css({"background-image":"url("+h+")","background-size":"cover"})}else f.css({"background-image":"url(https://static.hashtagsell.com/htsApp/placeholders/header-placeholder.png)","background-size":"cover"});var i=angular.element(c[0].querySelector(".splash-bs-username")),j=angular.element(c[0].querySelector(".bs-profile-image"));"APSTD"===b.result.external.source.code?(j.css({"background-image":"url(https://static.hashtagsell.com/logos/marketplaces/apartments_com_splash.png)","background-size":"cover"}),i.html("@apartments.com")):"AUTOD"===b.result.external.source.code?(j.css({"background-image":"url(https://static.hashtagsell.com/logos/marketplaces/autotrader_splash.png)","background-size":"cover"}),i.html("@autotrader.com")):"BKPGE"===b.result.external.source.code?(j.css({"background-image":"url(https://static.hashtagsell.com/logos/marketplaces/backpage_splash.png)","background-size":"cover"}),i.html("@backpage.com")):"CRAIG"===b.result.external.source.code?(j.css({"background-image":"url(https://static.hashtagsell.com/logos/marketplaces/craigslist_splash.png)","background-size":"cover"}),i.html("@craigslist.com")):"EBAYM"===b.result.external.source.code?(j.css({"background-image":"url(https://static.hashtagsell.com/logos/marketplaces/ebay_motors_splash.png)","background-size":"cover"}),i.html("@ebaymotors.com")):"E_BAY"===b.result.external.source.code&&(j.css({"background-image":"url(https://static.hashtagsell.com/logos/marketplaces/ebay_splash.png)","background-size":"cover"}),i.html("@ebay.com"))}}}}]),htsApp.factory("splashFactory",["$http","$location","$q","ENV",function(a,b,c,d){var e=new Hashtable;e.put("source_neighborhood","Neighborhood"),e.put("year","Year"),e.put("condition","Condition"),e.put("make","Make"),e.put("title_status","Title"),e.put("model","Model"),e.put("mileage","Mileage"),e.put("transmission","Transmission"),e.put("drive","Drive"),e.put("paint_color","Paint"),e.put("type","Type"),e.put("fuel","Fuel"),e.put("size","Size"),e.put("bathrooms","Bath"),e.put("available","Available"),e.put("no_smoking","Smoking"),e.put("bedrooms","Rooms"),e.put("dogs","Dogs"),e.put("cats","Cats"),e.put("attached_garage","Garage"),e.put("laundry_on_site","Laundry"),e.put("sqft","Sq Ft"),e.put("size_dimensions","Dimensions"),e.put("body_type","Body Type"),e.put("drive_type","Drive Type"),e.put("engine","Engine"),e.put("exterior_color","Exterior Color"),e.put("for_sale_by","Seller Type"),e.put("interior_color","Interior Color"),e.put("fuel_type","Fuel Type"),e.put("listing_type","Listing Type"),e.put("number_of_cylinders","Cylinders"),e.put("options","Options"),e.put("power_options","Power Options"),e.put("safety_features","Safety"),e.put("ship_to_location","Ship To"),e.put("trim","Trim"),e.put("vehicle_title","Title"),e.put("vin","Vin"),e.put("warranty","Warranty"),e.put("bodyStyle","Body Type"),e.put("drivetrain","Drive Train"),e.put("exteriorColor","Exterior Color"),e.put("interiorColor","Interior Color"),e.put("seller","Seller Type");var f={};return f.sanitizeAnnotations=function(a){var b={};return angular.forEach(a,function(a,c){if("string"==typeof c){var d=e.get(c);d&&(b[d]=a)}}),b},f.getUserProfile=function(d){var e=c.defer(),f=b.protocol()+"://"+b.host()+":"+b.port()+"/getprofile?username="+d;return a({method:"GET",url:f}).then(function(a,b,c,d){e.resolve(a)},function(a,b,c,d){e.reject(a)}),e.promise},f.lookupItemDetails=function(b){var e=c.defer();return a({method:"GET",url:d.postingAPI+b}).then(function(a,b,c,d){e.resolve(a)},function(a,b,c,d){e.reject(a)}),e.promise},f}]),htsApp.directive("transactionButtons",function(){return{restrict:"E",scope:{result:"="},templateUrl:"js/transactionButtons/partials/transactionButtons.partial.html",controller:["$scope","transactionFactory",function(a,b){a.quickCompose=function(){b.quickCompose(a.result)},a.displayPhone=function(){b.displayPhone(a.result)},a.openSplash=function(){b.openSplash(a.result)},a.placeBid=function(){b.placeBid(a.result)},a.placeOffer=function(){b.placeOffer(a.result)}}]}}),htsApp.factory("transactionFactory",["Session","$modal","$log","authModalFactory","quickComposeFactory","splashFactory","$window","$state",function(a,b,c,d,e,f,g,h){var i={};return i.quickCompose=function(f){if(console.log("item we clicked on",f),a.userObj.user_settings.loggedIn)if("ask"===a.userObj.user_settings.email_provider[0].value){var g=b.open({templateUrl:"/js/transactionButtons/modals/email/partials/transactionButtons.modal.email.partial.html",controller:"quickComposeController",resolve:{result:function(){return f}}});g.result.then(function(a){},function(a){console.log(a),"signUp"===a&&d.signUpModal(),c.info("Modal dismissed at: "+new Date)})}else e.generateMailTo(a.userObj.user_settings.email_provider[0].value,f);else d.signInModal()},i.displayPhone=function(e){if(a.userObj.user_settings.loggedIn){var f=b.open({templateUrl:"/js/transactionButtons/modals/phone/partials/transactionButtons.modal.phone.partial.html",controller:"phoneModalController",resolve:{result:function(){return e}}});f.result.then(function(a){},function(a){console.log(a),"signUp"===a&&d.signUpModal(),c.info("Modal dismissed at: "+new Date)})}else d.signInModal()},i.openSplash=function(a){f.result=a,h.go("results.splash",{id:a.external.source.url})},i.placeBid=function(b){a.userObj.user_settings.loggedIn?g.open(b.external.source.url):d.signInModal()},i.showOriginal=function(b){a.userObj.user_settings.loggedIn?g.open(b.external.source.url):d.signInModal()},i.placeOffer=function(e){if(a.userObj.user_settings.loggedIn){var f=b.open({templateUrl:"/js/transactionButtons/modals/placeOffer/partials/transactionButtons.modal.placeOffer.partial.html",controller:"placeOfferController",resolve:{result:function(){return e}}});f.result.then(function(a){},function(a){console.log(a),"signUp"===a&&d.signUpModal(),c.info("Modal dismissed at: "+new Date)})}else d.signUpModal()},i}]),htsApp.controller("quickComposeController",["$scope","$modalInstance","quickComposeFactory","Session","$window","result",function(a,b,c,d,e,f){a.userObj=d.userObj,a.emailOptionsObject=[{name:"Use Default Mail Client",value:"mailto"},{name:"Gmail",value:"gmail"},{name:"Yahoo",value:"yahoo"},{name:"Hotmail",value:"hotmail"},{name:"AOL",value:"aol"}],a.selected="mailto",a.qcEmail=function(){a.setDefaultEmailProvider&&c.setDefaultEmailProvider(a.selected),c.generateMailTo(a.selected,f),b.dismiss("auto-compose complete")},a.dismiss=function(a){b.dismiss(a)}}]),htsApp.factory("quickComposeFactory",["Session","$window",function(a,b){var c={};return c.generateMailTo=function(a,c){var d="";if(c.length){var e="";for(i=0;i<c.length;i++)c[i].annotations.source_account&&(e+=c[i].annotations.source_account+",");switch(a){case"gmail":d="https://mail.google.com/mail/?view=cm&fs=1&bcc="+e+"&su=I'd like to buy your item...&body=HashtagSell.com - Re-thinking Online Classifieds",b.open(d);break;case"yahoo":d="http://compose.mail.yahoo.com/?bcc="+e+"&subject=I'd like to buy your item...&body=HashtagSell.com - Re-thinking Online Classifieds",b.open(d);break;case"hotmail":d="https://mail.live.com/default.aspx?rru=compose&bcc="+e+"&subject=I'd like to buy your item...&body=HashtagSell.com - Re-thinking Online Classifieds",b.open(d);break;case"aol":d="http://mail.aol.com/mail/compose-message.aspx?bcc="+e+"&subject=I'd like to buy your item...&body=HashtagSell.com - Re-thinking Online Classifieds",b.open(d);break;case"mailto":d="mailto:?bcc="+e+"&subject=I'd like to buy your item...&body=HashtagSell.com - Re-thinking Online Classifieds",b.open(d)}}else switch(a){case"gmail":d="https://mail.google.com/mail/?view=cm&fs=1&to="+c.annotations.source_account+"&su="+c.heading+"&body="+c.external.source.url,b.open(d);break;case"yahoo":d="http://compose.mail.yahoo.com/?to="+c.annotations.source_account+"&subject="+c.heading+"&body="+c.external.source.url,b.open(d);break;case"hotmail":d="https://mail.live.com/default.aspx?rru=compose&to="+c.annotations.source_account+"&subject="+c.heading+"&body="+c.external.source.url,b.open(d);break;case"aol":d="http://mail.aol.com/mail/compose-message.aspx?to="+c.annotations.source_account+"&subject="+c.heading+"&body="+c.external.source.url,b.open(d);break;case"mailto":d="mailto:"+c.annotations.source_account+"?Subject="+c.heading+"&body="+c.external.source.url,b.open(d)}},c.setDefaultEmailProvider=function(b){var c;switch(b){case"ask":c=[{name:"Always Ask",value:"ask"}];break;case"gmail":c=[{name:"Gmail",value:"gmail"}];break;case"yahoo":c=[{name:"Yahoo",value:"yahoo"}];break;case"hotmail":c=[{name:"Hotmail",value:"hotmail"}];break;case"aol":c=[{name:"AOL",value:"aol"}];break;case"mailto":c=[{name:"Use Default Mail Client",value:"mailto"}]}a.setSessionValue("email_provider",c,function(){console.log("default email updated")})},c}]),htsApp.controller("phoneModalController",["$scope","$modalInstance","Session","result",function(a,b,c,d){a.userObj=c.userObj,a.result=d,a.dismiss=function(a){b.dismiss(a)}}]),htsApp.controller("placeOfferController",["$scope","$modalInstance","Session","result","ENV","$filter","offersFactory","favesFactory","socketio",function(a,b,c,d,e,f,g,h,i){a.userObj=c.userObj,a.result=d,a.disableSubmission=!0,a.offer={proposedTimes:[],username:a.userObj.user_settings.name},a.onTimeSet=function(b,c){a.dropDownStatus.isOpen=!1,b=f("date")(b,"yyyy-MM-ddTHH:mm:ssZ"),a.addProposedTime(b),a.data.dateDropDownInput=null,console.log(b)},a.dropDownStatus={isOpen:!1},a.dismiss=function(a){b.dismiss(a)},a.addProposedTime=function(b){a.offer.proposedTimes.push({when:b,where:d.external.threeTaps.location.formatted}),a.disableSubmission=a.validateProposal()},a.removeProposedTime=function(b){a.offer.proposedTimes.splice(b,1),a.disableSubmission=a.validateProposal()},a.validateProposal=function(){return a.offer.proposedTimes.length<1},a.sendOffer=function(){i.joinPostingRoom(a.result.postingId,"inWatchList",function(){g.sendOffer(a.result.postingId,a.offer).then(function(b){a.dismiss("offer sent")},function(b){a.dismiss("error"),alert(b)})})}}]),htsApp.controller("userMenu",["$scope","Session","authModalFactory","$modal","newPostFactory",function(a,b,c,d,e){a.userObj=b.userObj,a.logout=function(){b.destroy()},a.signIn=function(a){c.signInModal()},a.signUp=function(a){c.signUpModal()},a.checkEmail=function(a){c.checkEmailModal()},a.forgotPassword=function(a){c.forgotPasswordModal()},a.newPost=function(){var b=d.open({templateUrl:"/js/newPost/modals/newPost/partials/newpost.html",controller:"newPostModal",size:"lg",resolve:{mentionsFactory:function(){return e}}});b.result.then(function(b){a.modalContent.selected=b},function(){console.log("Modal dismissed at: "+new Date)})}}]),htsApp.factory("utilsFactory",["ENV",function(a){var b={};return b.bracketNotationURL=function(a,c,d){d=d||[];var e=0;for(var f in a)if(e++,a.hasOwnProperty(f))if(c||d.length?e>1&&d.length&&-1===c.indexOf("[")?c="&"+f:e>1&&d.length&&-1!==c.indexOf("[")?c=c.replace(/\[(.+?)\]/g,"["+f+"]"):c+="["+f+"]":c="?"+f,"object"==typeof a[f]&&null!==a[f]&&a[f].constructor!==Array)b.bracketNotationURL(a[f],c,d);else{var g=c;g+=a[f].constructor===Array?"="+a[f].join():"="+a[f],d.push(g)}return d.join("")},b}]),htsApp.factory("categoryFactory",["$http","$q","ENV",function(a,b,c){var d={};return d.lookupCategories=function(){var d=b.defer();return a({method:"GET",url:c.groupingsAPI}).then(function(a,b,c,e){console.log("reference api response",a),d.resolve(a)},function(a,b,c,e){d.reject(a)}),d.promise},d}]),htsApp.factory("ebayFactory",["$q","$http","$window","$rootScope","$timeout","$interval","ENV","Session","Notification",function(a,b,c,d,e,f,g,h,i){var j={};j.publishToEbay=function(c){var d=a.defer(),e=h.getSessionValue("ebay"),f={ebay:!0};return j.isEmpty(e)?j.getEbaySessionID().then(function(a){h.setSessionValue("ebay",a.data.ebay,function(){b.post(g.postingAPI+c.postingId+"/publish",f).success(function(a){d.resolve(a)}).error(function(a){d.reject(a)})})},function(a){i.error({title:"Manually link eBay account",message:"After completing eBay authorization please click the big red button below.",delay:1e4})}):b.post(g.postingAPI+c.postingId+"/publish",f).success(function(a){d.resolve(a)}).error(function(a){d.reject(a)}),d.promise},j.getEbaySessionID=function(){var d=a.defer(),e=c.open(g.htsAppUrl+"/ebayauth","","width=1020, height=500");return b({method:"GET",url:g.ebayAuth+"/sessionId"}).then(function(a){var c=a.data.GetSessionIDResponse.SessionID,h=g.ebaySignIn+"?SignIn&RUName="+g.ebayRuName+"&SessID="+c;e.location=h;var i=0,j=f(function(){b({method:"GET",url:g.ebayAuth+"/fetchToken",params:{sessionId:c}}).then(function(a){console.log(a),a.data.success?(e.close(),f.cancel(j),d.resolve(a)):50===i?(f.cancel(j),a.data.sessionId=c,d.reject(a)):(i++,console.log(i))})},2e3)},function(a){d.reject(a)}),d.promise},j.manuallyGetEbayToken=function(c){var d=a.defer();return b({method:"GET",url:g.ebayAuth+"/fetchToken",params:{sessionId:c}}).then(function(a){d.resolve(a)},function(a){d.reject(a)}),d.promise},j.disconnectEbay=function(){h.setSessionValue("ebay",{},function(){console.log("ebay account disconnected!")})};var k=Object.prototype.hasOwnProperty;return j.isEmpty=function(a){if(null===a)return!0;if(a.length>0)return!1;if(0===a.length)return!0;for(var b in a)if(k.call(a,b))return!1;return!0},j}]),htsApp.factory("facebookFactory",["$q","ENV","Session","ezfb",function(a,b,c,d){var e={};e.publishToWall=function(f){var g=a.defer(),h=c.getSessionValue("facebook");console.log("facebook tokens",h);var i=new Date;return!e.isEmpty(h)&&h.tokenExpiration>i||!e.isEmpty(h)&&!h.tokenExpiration?d.api("/me/feed","post",{message:b.htsAppUrl+"/fb/"+f.postingId,link:b.htsAppUrl+"/fb/"+f.postingId,access_token:h.token},function(a){a.error?g.reject(a):g.resolve(a)}):d.login(function(a){if(a.authResponse){console.log("res AuthResponse",a);var e=new Date;e.setSeconds(a.authResponse.expiresIn);var h={};h.id=a.authResponse.userID,h.token=a.authResponse.accessToken,h.tokenExpiration=e,d.api("/me",function(a){console.log("apiMe",a),h.email=a.email,h.name=a.first_name+" "+a.last_name,console.log(h),c.setSessionValue("facebook",h,function(){d.api("/me/feed","post",{message:b.htsAppUrl+"/fb/"+f.postingId,link:b.htsAppUrl+"/fb/"+f.postingId,access_token:h.token},function(a){a.error?g.reject(a):g.resolve(a)})})})}},{scope:"email, publish_actions"}),g.promise},e.disconnectFacebook=function(){c.setSessionValue("facebook",{},function(){console.log("facebook account disconnected!")})};var f=Object.prototype.hasOwnProperty;return e.isEmpty=function(a){if(null===a)return!0;if(a.length>0)return!1;if(0===a.length)return!0;for(var b in a)if(f.call(a,b))return!1;return!0},e}]),htsApp.factory("twitterFactory",["$q","$http","$window","$interval","ENV","Session",function(a,b,c,d,e,f){var g={};g.publishToTwitter=function(h){var i=a.defer(),j=f.getSessionValue("twitter");if(g.isEmpty(j))var k=c.open(e.htsAppUrl+"/auth/twitter","","width=1020, height=500"),l=0,m=d(function(){f.getUserFromServer().then(function(a){console.log(a),a.user_settings.linkedAccounts.twitter.token?(d.cancel(m),k.close(),f.create(a),b({method:"POST",url:e.htsAppUrl+"/publishTweet",data:{status:e.htsAppUrl+"/tw/"+h.postingId,token:a.user_settings.linkedAccounts.twitter.token,tokenSecret:a.user_settings.linkedAccounts.twitter.tokenSecret}}).then(function(a){i.resolve(a)},function(a){i.reject(a)})):50===l?(d.cancel(m),i.reject(a)):(l++,console.log(l))})},2e3);else b({method:"POST",url:e.htsAppUrl+"/publishTweet",data:{status:e.htsAppUrl+"/tw/"+h.postingId,token:j.token,tokenSecret:j.tokenSecret}}).then(function(a){i.resolve(a)},function(a){i.reject(a)});return i.promise},g.disconnectTwitter=function(){f.setSessionValue("twitter",{},function(){console.log("twitter account disconnected!")})};var h=Object.prototype.hasOwnProperty;return g.isEmpty=function(a){if(null===a)return!0;if(a.length>0)return!1;if(0===a.length)return!0;for(var b in a)if(h.call(a,b))return!1;return!0},g}]);